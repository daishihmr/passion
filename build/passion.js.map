{"version":3,"sources":["main.js","Application.js","Assets.js","Camera.js","Bullet.js","BulletDrawer.js","GLLayer.js","Player.js","SpritDrawer.js","Sprite.js","Pool.js","GameScene.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"passion.js","sourcesContent":["var SCREEN_WIDTH = 360;\r\nvar SCREEN_HEIGHT = 640;\r\nvar GAME_AREA_WIDTH = SCREEN_WIDTH;\r\nvar GAME_AREA_HEIGHT = SCREEN_HEIGHT * 0.85;\r\nvar FPS = 30;\r\n\r\nphina.main(function() {\r\n\r\n  phina.display.DisplayScene.defaults.$extend({\r\n    width: SCREEN_WIDTH,\r\n    height: SCREEN_HEIGHT,\r\n    backgroundColor: \"transparent\",\r\n  });\r\n\r\n  var app = passion.Application();\r\n  app.enableStats();\r\n  app.run();\r\n\r\n  app.replaceScene(phina.game.ManagerScene({\r\n    scenes: [\r\n\r\n      {\r\n        className: \"phina.game.LoadingScene\",\r\n        arguments: {\r\n          assets: passion.Assets.get({ assetType: \"common\" }),\r\n        },\r\n      },\r\n\r\n      {\r\n        className: \"passion.GameScene\",\r\n      },\r\n\r\n    ]\r\n  }));\r\n\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.Application\", {\r\n    superClass: \"phina.display.CanvasApp\",\r\n\r\n    init: function() {\r\n      this.superInit({\r\n        width: SCREEN_WIDTH,\r\n        height: SCREEN_HEIGHT,\r\n        backgroundColor: \"#114\",\r\n      });\r\n\r\n      this.fps = FPS;\r\n    },\r\n\r\n  });\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.Assets\", {\r\n    _static: {\r\n      get: function(options) {\r\n        switch (options.assetType) {\r\n          case \"common\":\r\n            return {\r\n              image: {\r\n                \"bullets.png\": \"./asset/image/bullets.png\",\r\n                \"test.png\": \"./asset/image/test.png\",\r\n              },\r\n              vertexShader: {\r\n                \"bullets.vs\": \"./asset/shader/bullets.vs\",\r\n                \"sprites.vs\": \"./asset/shader/sprites.vs\",\r\n              },\r\n              fragmentShader: {\r\n                \"bullets.fs\": \"./asset/shader/bullets.fs\",\r\n                \"sprites.fs\": \"./asset/shader/sprites.fs\",\r\n              },\r\n            };\r\n          default:\r\n            throw \"invalid assetType: \" + options.assetType;\r\n        }\r\n      },\r\n    },\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.Camera\", {\r\n\r\n    position: null,\r\n    vMatrix: null,\r\n    pMatrix: null,\r\n    vpMatrix: null,\r\n\r\n    init: function() {\r\n      this.position = vec3.create();\r\n      this.vMatrix = mat4.create();\r\n      this.pMatrix = mat4.create();\r\n      this.vpMatrix = mat4.create();\r\n    },\r\n\r\n    setPosition: function(x, y, z) {\r\n      vec3.set(this.position, x, y, z);\r\n      return this;\r\n    },\r\n\r\n    lookAt: function(x, y, z) {\r\n      mat4.lookAt(this.vMatrix, this.position, [x, y, z], [0, 1, 0]);\r\n      return this;\r\n    },\r\n\r\n    ortho: function(left, right, bottom, top, near, far) {\r\n      mat4.ortho(this.pMatrix, left, right, bottom, top, near, far);\r\n      return this;\r\n    },\r\n\r\n    perspective: function(fovy, aspect, near, far) {\r\n      mat4.perspective(this.pMatrix, fovy, aspect, near, far);\r\n      return this;\r\n    },\r\n\r\n    calcVpMatrix: function() {\r\n      mat4.mul(this.vpMatrix, this.pMatrix, this.vMatrix);\r\n      return this;\r\n    },\r\n\r\n    uniformValues: function() {\r\n      return {\r\n        vpMatrix: this.vpMatrix,\r\n        cameraPosition: this.position,\r\n      };\r\n    }\r\n\r\n  });\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.Bullet\", {\r\n    superClass: \"phina.app.Element\",\r\n\r\n    id: -1,\r\n    instanceData: null,\r\n    runner: null,\r\n\r\n    x: 0,\r\n    y: 0,\r\n    age: 0,\r\n\r\n    power: 0,\r\n\r\n    _active: false,\r\n    \r\n    radius: 20,\r\n\r\n    init: function(id, instanceData, instanceStride) {\r\n      this.superInit();\r\n      this.id = id;\r\n      this.instanceData = instanceData;\r\n\r\n      this.index = id * instanceStride;\r\n    },\r\n\r\n    spawn: function(runner, option) {\r\n      var instanceData = this.instanceData;\r\n      var index = this.index;\r\n\r\n      this.runner = runner;\r\n      this.x = runner.x;\r\n      this.y = runner.y;\r\n      this.age = 0;\r\n      instanceData[index + 0] = this.x;\r\n      instanceData[index + 1] = this.y;\r\n      instanceData[index + 2] = runner.direction; // rotation\r\n      instanceData[index + 3] = 2.8; // scale\r\n      instanceData[index + 4] = option.type % 8; // frame.x\r\n      instanceData[index + 5] = ~~(option.type / 8); // frame.y\r\n      instanceData[index + 6] = 1; // visible\r\n      instanceData[index + 7] = 1; // brightness\r\n      instanceData[index + 8] = 0.2 + ~~(option.type / 8) % 2; // auraColor.r\r\n      instanceData[index + 9] = 0.2 + 0; // auraColor.g\r\n      instanceData[index + 10] = 0.2 + ~~(option.type / 8) % 2 + 1; // auraColor.b\r\n\r\n      var self = this;\r\n      runner.onVanish = function() {\r\n        self.remove();\r\n      };\r\n\r\n      return this;\r\n    },\r\n\r\n    activate: function() {\r\n      this._active = true;\r\n      this.flare(\"activated\");\r\n      return this;\r\n    },\r\n\r\n    inactivate: function() {\r\n      this._active = false;\r\n      this.flare(\"inactivated\");\r\n      return this;\r\n    },\r\n\r\n    onremoved: function() {\r\n      this.instanceData[this.index + 6] = 0;\r\n    },\r\n\r\n    update: function(app) {\r\n      var instanceData = this.instanceData;\r\n      var index = this.index;\r\n      var runner = this.runner;\r\n\r\n      runner.update();\r\n      this.x = runner.x;\r\n      this.y = runner.y;\r\n\r\n      if (this.x < -100 || SCREEN_WIDTH + 100 < this.x || this.y < -100 || SCREEN_HEIGHT + 100 < this.y) {\r\n        this.remove();\r\n        return;\r\n      }\r\n\r\n      instanceData[index + 0] = this.x;\r\n      instanceData[index + 1] = this.y;\r\n      instanceData[index + 7] = 1.5 + Math.sin(this.age * 0.2) * 0.6;\r\n\r\n      this.age += 1;\r\n    },\r\n\r\n    hitPlayer: function(player) {\r\n      // TODO\r\n      this.remove();\r\n    },\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n  phina.define(\"passion.BulletDrawer\", {\r\n    superClass: \"phigl.InstancedDrawable\",\r\n\r\n    instanceData: null,\r\n\r\n    pool: null,\r\n    _count: 2000,\r\n\r\n    init: function(gl, ext, w, h) {\r\n      this.superInit(gl, ext);\r\n\r\n      var shader = phigl.Program(gl)\r\n        .attach(\"bullets.vs\")\r\n        .attach(\"bullets.fs\")\r\n        .link();\r\n\r\n      this\r\n        .setProgram(shader)\r\n        .setDrawMode(gl.TRIANGLE_STRIP)\r\n        .setIndexValues([0, 1, 2, 3])\r\n        .setAttributes(\"position\", \"uv\")\r\n        .setAttributeDataArray([{\r\n          unitSize: 2,\r\n          data: [\r\n            //\r\n            -16, +16,\r\n            //\r\n            +16, +16,\r\n            //\r\n            -16, -16,\r\n            //\r\n            +16, -16,\r\n          ]\r\n        }, {\r\n          unitSize: 2,\r\n          data: [\r\n            //\r\n            0, 32 / 256,\r\n            //\r\n            32 / 256, 32 / 256,\r\n            //\r\n            0, 0,\r\n            //\r\n            32 / 256, 0,\r\n          ]\r\n        }, ])\r\n        .setInstanceAttributes(\r\n          \"instancePosition\",\r\n          \"instanceRotation\",\r\n          \"instanceScale\",\r\n          \"instanceFrame\",\r\n          \"instanceVisible\",\r\n          \"instanceBrightness\",\r\n          \"instanceAuraColor\"\r\n        )\r\n        .setUniforms(\r\n          \"vpMatrix\",\r\n          \"texture\",\r\n          \"globalScale\"\r\n        );\r\n\r\n      var instanceUnit = this.instanceStride / 4;\r\n      \r\n      var texture = phigl.Texture(gl, \"bullets.png\");\r\n\r\n      this.uniforms.texture.setValue(0).setTexture(texture);\r\n      this.uniforms.globalScale.setValue(1.0);\r\n\r\n      var instanceData = this.instanceData = [];\r\n      for (var i = 0; i < this._count; i++) {\r\n        instanceData.push(\r\n          // position\r\n          0, 0,\r\n          // rotation\r\n          0,\r\n          // scale\r\n          1,\r\n          // frame\r\n          0, 0,\r\n          // visible\r\n          0,\r\n          // brightness\r\n          0,\r\n          // auraColor\r\n          0, 0, 0\r\n        );\r\n      }\r\n      this.setInstanceAttributeData(instanceData);\r\n\r\n      var self = this;\r\n      this.pool = Array.range(0, this._count)\r\n        .map(function(id) {\r\n          return passion.Bullet(id, instanceData, instanceUnit)\r\n            .on(\"removed\", function() {\r\n              self.pool.add(this);\r\n            });\r\n        })\r\n        .toPool(function(lhs, rhs) {\r\n          return lhs.id - rhs.id;\r\n        });\r\n    },\r\n\r\n    get: function() {\r\n      return this.pool.get();\r\n    },\r\n\r\n    update: function(app) {\r\n      this.setInstanceAttributeData(this.instanceData);\r\n    },\r\n\r\n    render: function(uniforms) {\r\n      var gl = this.gl;\r\n      gl.enable(gl.BLEND);\r\n      gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n      gl.disable(gl.DEPTH_TEST);\r\n\r\n      this.uniforms.globalScale.value = 1.0;\r\n      if (uniforms) {\r\n        uniforms.forIn(function(key, value) {\r\n          if (this.uniforms[key]) this.uniforms[key].value = value;\r\n        }.bind(this));\r\n      }\r\n\r\n      this.draw(this._count);\r\n    },\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n  \r\n  phina.define(\"passion.GLLayer\", {\r\n    superClass: \"phina.display.Layer\",\r\n\r\n    static: {\r\n      GL_CANVAS: null,\r\n      GL: null,\r\n    },\r\n\r\n    renderChildBySelf: true,\r\n    ready: false,\r\n\r\n    domElement: null,\r\n    gl: null,\r\n\r\n    camera: null,\r\n\r\n    enemyDrawer: null,\r\n    effectDrawer: null,\r\n    bulletDrawer: null,\r\n    playerDrawer: null,\r\n\r\n    init: function() {\r\n      this.superInit({\r\n        width: GAME_AREA_WIDTH,\r\n        height: GAME_AREA_HEIGHT,\r\n      });\r\n      this.originX = 0;\r\n      this.originY = 0;\r\n\r\n      if (passion.GLLayer.GL_CANVAS == null) {\r\n        passion.GLLayer.GL_CANVAS = document.createElement(\"canvas\");\r\n        passion.GLLayer.GL = passion.GLLayer.GL_CANVAS.getContext(\"webgl\");\r\n      }\r\n\r\n      this.domElement = passion.GLLayer.GL_CANVAS;\r\n      this.domElement.width = this.width * passion.GLLayer.quality;\r\n      this.domElement.height = this.height * passion.GLLayer.quality;\r\n\r\n      var gl = this.gl = passion.GLLayer.GL;\r\n      var extInstancedArrays = phigl.Extensions.getInstancedArrays(gl);\r\n\r\n      gl.viewport(0, 0, this.domElement.width, this.domElement.height);\r\n      gl.clearColor(0.0, 0.0, 0.0, 1.0);\r\n      gl.clearDepth(1.0);\r\n      gl.disable(gl.CULL_FACE);\r\n\r\n      var cw = this.domElement.width;\r\n      var ch = this.domElement.height;\r\n      var w = this.width;\r\n      var h = this.height;\r\n      var sw = Math.pow(2, ~~Math.log2(cw) + 1);\r\n      var sh = Math.pow(2, ~~Math.log2(ch) + 1);\r\n\r\n      this.camera = passion.Camera()\r\n        .setPosition(w * 0.5, h * 0.5, 2000)\r\n        .lookAt(w * 0.5, h * 0.5, 0)\r\n        .ortho(-w * 0.5, w * 0.5, h * 0.5, -h * 0.5, 0.1, 3000)\r\n        .calcVpMatrix();\r\n\r\n      this.enemyDrawer = passion.SpritDrawer(gl, extInstancedArrays, w, h);\r\n      this.effectDrawer = passion.SpritDrawer(gl, extInstancedArrays, w, h);\r\n      this.bulletDrawer = passion.BulletDrawer(gl, extInstancedArrays, w, h);\r\n      this.playerDrawer = passion.SpritDrawer(gl, extInstancedArrays, w, h);\r\n\r\n      this.ready = true;\r\n    },\r\n\r\n    update: function(app) {\r\n      if (!this.ready) return;\r\n\r\n      this.enemyDrawer.update(app);\r\n      this.effectDrawer.update(app);\r\n      this.bulletDrawer.update(app);\r\n      this.playerDrawer.update(app);\r\n    },\r\n\r\n    draw: function(canvas) {\r\n      if (!this.ready) return;\r\n\r\n      var gl = this.gl;\r\n      var image = this.domElement;\r\n      var cw = image.width;\r\n      var ch = image.height;\r\n\r\n      var ou = this.camera.uniformValues();\r\n\r\n      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\r\n\r\n      this.enemyDrawer.render(ou);\r\n      this.effectDrawer.render(ou);\r\n      this.bulletDrawer.render(ou);\r\n      this.playerDrawer.render(ou);\r\n\r\n      gl.flush();\r\n\r\n      canvas.context.drawImage(image, 0, 0, cw, ch, 0, 0, this.width, this.height);\r\n    },\r\n\r\n    _static: {\r\n      // quality: 0.5,\r\n      quality: 1.0,\r\n    },\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n  \r\n  phina.define(\"passion.Player\", {\r\n    superClass: \"passion.Sprite\",\r\n    \r\n    init: function(id, instanceData, instanceStride) {\r\n      this.superInit(id, instanceData, instanceStride);\r\n      this.on(\"enterframe\", function(e) {\r\n        this.controll(e.app);\r\n      });\r\n    },\r\n    \r\n    spawn: function() {\r\n      passion.Sprite.prototype.spawn.call(this, {\r\n        scaleX: 5,\r\n        scaleY: 5,\r\n        frameX: 0,\r\n        frameY: 0,\r\n        frameW: 1,\r\n        frameH: 1,\r\n      });\r\n      return this;\r\n    },\r\n    \r\n    controll: function(app) {\r\n      var p = app.pointer;\r\n      var dp = p.deltaPosition;\r\n      \r\n      if (p.getPointing()) {\r\n        this.x += dp.x * 2;\r\n        this.y += dp.y * 2;\r\n        \r\n        this.x = Math.clamp(this.x, 5, GAME_AREA_WIDTH - 5);\r\n        this.y = Math.clamp(this.y, 5, GAME_AREA_HEIGHT - 5);\r\n      }\r\n    },\r\n\r\n  });\r\n});","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.SpritDrawer\", {\r\n    superClass: \"phigl.InstancedDrawable\",\r\n\r\n    objTypes: null,\r\n    objParameters: null,\r\n\r\n    init: function(gl, ext, w, h) {\r\n      this.superInit(gl, ext);\r\n\r\n      this.objTypes = [];\r\n      this.objParameters = {};\r\n\r\n      var shader = phigl.Program(gl)\r\n        .attach(\"sprites.vs\")\r\n        .attach(\"sprites.fs\")\r\n        .link();\r\n\r\n      this\r\n        .setProgram(shader)\r\n        .setDrawMode(gl.TRIANGLE_STRIP)\r\n        .setIndexValues([0, 1, 2, 3])\r\n        .setAttributes(\"position\", \"uv\")\r\n        .setAttributeDataArray([{\r\n          unitSize: 2,\r\n          data: [\r\n            //\r\n            -5, +5,\r\n            //\r\n            +5, +5,\r\n            //\r\n            -5, -5,\r\n            //\r\n            +5, -5,\r\n          ]\r\n        }, {\r\n          unitSize: 2,\r\n          data: [\r\n            //\r\n            0, 1,\r\n            //\r\n            1, 1,\r\n            //\r\n            0, 0,\r\n            //\r\n            1, 0,\r\n          ]\r\n        }, ])\r\n        .setInstanceAttributes(\r\n          \"instanceVisible\",\r\n          \"instancePosition\",\r\n          \"instanceRotation\",\r\n          \"instanceScale\",\r\n          \"instanceFrame\",\r\n          \"instanceColor\"\r\n        )\r\n        .setUniforms(\r\n          \"vpMatrix\",\r\n          \"texture\",\r\n          \"globalScale\"\r\n        );\r\n\r\n      var instanceStride = this.instanceStride / 4;\r\n\r\n      this.uniforms.globalScale.setValue(1.0);\r\n    },\r\n\r\n    addObjType: function(objName, options) {\r\n      options = {}.$extend({\r\n        className: \"passion.Sprite\",\r\n        count: 1,\r\n        texture: null,\r\n        additiveBlending: false,\r\n      }, options);\r\n\r\n      if (!this.objTypes.contains(objName)) {\r\n        var self = this;\r\n        var instanceStride = this.instanceStride / 4;\r\n\r\n        this.objTypes.push(objName);\r\n        var objParameter = this.objParameters[objName] = {\r\n          count: options.count,\r\n          instanceVbo: phigl.Vbo(this.gl, this.gl.DYNAMIC_DRAW),\r\n          texture: phigl.Texture(this.gl, options.texture),\r\n          pool: null,\r\n          additiveBlending: options.additiveBlending,\r\n          instanceData: Array.range(options.count).map(function(i) {\r\n            return [\r\n              // visible\r\n              0,\r\n              // m0\r\n              1, 0, 0,\r\n              // m1\r\n              0, 1, 0,\r\n              // m2\r\n              0, 0, 1,\r\n              // m3\r\n              0, 0, 0,\r\n            ];\r\n          }).flatten(),\r\n        };\r\n\r\n        var ObjClass = phina.using(options.className);\r\n        objParameter.pool = Array.range(options.count).map(function(id) {\r\n          return ObjClass(id, objParameter.instanceData, instanceStride)\r\n            .on(\"removed\", function() {\r\n              objParameter.pool.push(this);\r\n            });\r\n        });\r\n      }\r\n    },\r\n\r\n    get: function(objName) {\r\n      return this.objParameters[objName].pool.shift();\r\n    },\r\n\r\n    update: function() {},\r\n\r\n    render: function(uniforms) {\r\n      var gl = this.gl;\r\n      gl.enable(gl.BLEND);\r\n      gl.disable(gl.DEPTH_TEST);\r\n\r\n      this.uniforms.globalScale.value = 1.0;\r\n\r\n      if (uniforms) {\r\n        uniforms.forIn(function(key, value) {\r\n          if (this.uniforms[key]) this.uniforms[key].value = value;\r\n        }.bind(this));\r\n      }\r\n      var self = this;\r\n      this.objTypes.forEach(function(objName) {\r\n        var objParameter = self.objParameters[objName];\r\n\r\n        if (objParameter.additiveBlending) {\r\n          gl.blendFunc(gl.SRC_ALPHA, gl.ONE);\r\n        } else {\r\n          gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n        }\r\n\r\n        self.setInstanceAttributeVbo(\r\n          objParameter.instanceVbo.set(objParameter.instanceData)\r\n        );\r\n        self.uniforms.texture.setValue(0).setTexture(objParameter.texture);\r\n        self.draw(objParameter.count);\r\n      });\r\n    },\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.Sprite\", {\r\n    superClass: \"phina.app.Element\",\r\n\r\n    id: -1,\r\n    instanceData: null,\r\n\r\n    visible: true,\r\n\r\n    x: 0,\r\n    y: 0,\r\n    rotation: 0,\r\n    scale: 0,\r\n\r\n    frameX: 0,\r\n    frameY: 0,\r\n    frameW: 0,\r\n    frameH: 0,\r\n\r\n    red: 1.0,\r\n    green: 1.0,\r\n    blue: 1.0,\r\n    alpha: 1.0,\r\n\r\n    age: 0,\r\n\r\n    init: function(id, instanceData, instanceStride) {\r\n      this.superInit();\r\n      this.id = id;\r\n      this.instanceData = instanceData;\r\n      this.index = id * instanceStride;\r\n    },\r\n\r\n    spawn: function(options) {\r\n      options.$safe({\r\n        visible: true,\r\n        x: 0,\r\n        y: 0,\r\n        rotation: 0,\r\n        scaleX: 1,\r\n        scaleY: 1,\r\n        frameX: 0,\r\n        frameY: 0,\r\n        frameW: 1 / 8,\r\n        frameH: 1 / 8,\r\n        red: 1.0,\r\n        green: 1.0,\r\n        blue: 1.0,\r\n        alpha: 1.0,\r\n      });\r\n\r\n      var index = this.index;\r\n      var instanceData = this.instanceData;\r\n\r\n      this.visible = options.visible;\r\n      this.x = options.x;\r\n      this.y = options.y;\r\n      this.rotation = options.rotation;\r\n      this.scaleX = options.scaleX;\r\n      this.scaleY = options.scaleY;\r\n      this.frameX = options.frameX;\r\n      this.frameY = options.frameY;\r\n      this.frameW = options.frameW;\r\n      this.frameH = options.frameH;\r\n      this.red = options.red;\r\n      this.green = options.green;\r\n      this.blue = options.blue;\r\n      this.alpha = options.alpha;\r\n\r\n      instanceData[index + 0] = this.visible ? 1 : 0; // visible\r\n      instanceData[index + 1] = this.x; // position.x\r\n      instanceData[index + 2] = this.y; // position.y\r\n      instanceData[index + 3] = this.rotation; // rotation\r\n      instanceData[index + 4] = this.scaleX; // scale\r\n      instanceData[index + 5] = this.scaleY; // scale\r\n      instanceData[index + 6] = this.frameX; // frame.x\r\n      instanceData[index + 7] = this.frameY; // frame.y\r\n      instanceData[index + 8] = this.frameW; // frame.w\r\n      instanceData[index + 9] = this.frameH; // frame.h\r\n      instanceData[index + 10] = this.red; // red\r\n      instanceData[index + 11] = this.green; // green\r\n      instanceData[index + 12] = this.blue; // blue\r\n      instanceData[index + 13] = this.alpha; // alpha\r\n\r\n      this.age = 0;\r\n\r\n      return this;\r\n    },\r\n\r\n    update: function(app) {\r\n      var index = this.index;\r\n      var instanceData = this.instanceData;\r\n\r\n      instanceData[index + 0] = this.visible ? 1 : 0; // visible\r\n      instanceData[index + 1] = this.x; // position.x\r\n      instanceData[index + 2] = this.y; // position.y\r\n      instanceData[index + 3] = this.rotation; // rotation\r\n      instanceData[index + 4] = this.scaleX; // scale\r\n      instanceData[index + 5] = this.scaleY; // scale\r\n      instanceData[index + 6] = this.frameX; // frame.x\r\n      instanceData[index + 7] = this.frameY; // frame.y\r\n      instanceData[index + 8] = this.frameW; // frame.w\r\n      instanceData[index + 9] = this.frameH; // frame.h\r\n      instanceData[index + 10] = this.red; // red\r\n      instanceData[index + 11] = this.green; // green\r\n      instanceData[index + 12] = this.blue; // blue\r\n      instanceData[index + 13] = this.alpha; // alpha\r\n\r\n      this.age += 1;\r\n    },\r\n\r\n    onremoved: function() {\r\n      this.visible = false;\r\n      this.instanceData[this.index + 0] = 0;\r\n    },\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.Pool\", {\r\n\r\n    array: null,\r\n    dirty: null,\r\n    comparator: null,\r\n\r\n    init: function(array, comparator) {\r\n      this.array = array || [];\r\n      this.comparator = comparator || function(lhs, rhs) {\r\n        return lhs - rhs;\r\n      };\r\n      this.dirty = true;\r\n    },\r\n\r\n    add: function(obj) {\r\n      this.array.push(obj);\r\n      this.dirty = true;\r\n    },\r\n\r\n    get: function() {\r\n      if (this.dirty) {\r\n        this.array.sort(this.comparator);\r\n        this.dirty = false;\r\n      }\r\n      return this.array.shift();\r\n    },\r\n  });\r\n\r\n  Array.prototype.$method(\"toPool\", function(comparator) {\r\n    return passion.Pool(this, comparator);\r\n  });\r\n\r\n});\r\n","phina.namespace(function() {\r\n\r\n  phina.define(\"passion.GameScene\", {\r\n    superClass: \"phina.display.DisplayScene\",\r\n\r\n    init: function() {\r\n      this.superInit();\r\n\r\n      var bgTexture = phina.graphics.Canvas();\r\n      bgTexture.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);\r\n      bgTexture.clearColor(\"hsl(220, 70%, 20%)\");\r\n      bgTexture.strokeStyle = \"hsl(220, 70%, 60%)\";\r\n      (90).times(function(i, j) {\r\n        bgTexture.drawLine(0, SCREEN_HEIGHT / j * i, SCREEN_WIDTH, SCREEN_HEIGHT / j * i);\r\n      });\r\n      (60).times(function(i, j) {\r\n        bgTexture.drawLine(SCREEN_WIDTH / j * i, 0, SCREEN_WIDTH / j * i, SCREEN_HEIGHT);\r\n      });\r\n\r\n      this.fromJSON({\r\n        children: {\r\n          bg: {\r\n            className: \"phina.display.Sprite\",\r\n            arguments: bgTexture,\r\n            originX: 0,\r\n            originY: 0,\r\n          },\r\n          glLayer: {\r\n            className: \"passion.GLLayer\",\r\n          },\r\n          uiLayer: {\r\n            className: \"phina.display.DisplayElement\",\r\n            originX: 0,\r\n            originY: 0,\r\n          },\r\n        },\r\n      });\r\n      \r\n      this.glLayer.playerDrawer.addObjType(\"test\", {\r\n        className: \"passion.Player\",\r\n        texture: \"test.png\",\r\n      });\r\n      \r\n      var player = this.glLayer.playerDrawer.get(\"test\");\r\n      player.spawn();\r\n      player.addChildTo(this.glLayer);\r\n      player.x = 100;\r\n      player.y = 100;\r\n    },\r\n\r\n  });\r\n});\r\n"],"sourceRoot":"/source/"}