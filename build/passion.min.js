var SCREEN_WIDTH=360,SCREEN_HEIGHT=640,GAME_AREA_WIDTH=SCREEN_WIDTH,GAME_AREA_HEIGHT=.85*SCREEN_HEIGHT,FPS=60;phina.main(function(){phina.display.DisplayScene.defaults.$extend({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"transparent"});var t=passion.Application();t.enableStats(),t.run(),t.replaceScene(phina.game.ManagerScene({scenes:[{className:"phina.game.LoadingScene",arguments:{assets:passion.Assets.get({assetType:"common"})}},{className:"passion.GameScene"}]}))}),phina.namespace(function(){phina.define("passion.Application",{superClass:"phina.display.CanvasApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"#114"}),this.fps=FPS}})}),phina.namespace(function(){phina.define("passion.Assets",{_static:{get:function(t){switch(t.assetType){case"common":return{image:{"bullets.png":"./asset/image/bullets.png","texture0.png":"./asset/image/texture0.png"},vertexShader:{"bullets.vs":"./asset/shader/bullets.vs","sprites.vs":"./asset/shader/sprites.vs"},fragmentShader:{"bullets.fs":"./asset/shader/bullets.fs","sprites.fs":"./asset/shader/sprites.fs"}};default:throw"invalid assetType: "+t.assetType}}}})}),phina.namespace(function(){phina.define("passion.Camera",{position:null,vMatrix:null,pMatrix:null,vpMatrix:null,init:function(){this.position=vec3.create(),this.vMatrix=mat4.create(),this.pMatrix=mat4.create(),this.vpMatrix=mat4.create()},setPosition:function(t,i,e){return vec3.set(this.position,t,i,e),this},lookAt:function(t,i,e){return mat4.lookAt(this.vMatrix,this.position,[t,i,e],[0,1,0]),this},ortho:function(t,i,e,a,s,n){return mat4.ortho(this.pMatrix,t,i,e,a,s,n),this},perspective:function(t,i,e,a){return mat4.perspective(this.pMatrix,t,i,e,a),this},calcVpMatrix:function(){return mat4.mul(this.vpMatrix,this.pMatrix,this.vMatrix),this},uniformValues:function(){return{vpMatrix:this.vpMatrix,cameraPosition:this.position}}})}),phina.namespace(function(){phina.define("passion.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,power:0,_active:!1,radius:20,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.index=t*e},spawn:function(t,i){var e=this.instanceData,a=this.index;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,e[a+0]=this.x,e[a+1]=this.y,e[a+2]=t.direction,e[a+3]=2.8,e[a+4]=i.type%8,e[a+5]=~~(i.type/8),e[a+6]=1,e[a+7]=1,e[a+8]=.2+~~(i.type/8)%2,e[a+9]=.2,e[a+10]=.2+~~(i.type/8)%2+1;var s=this;return t.onVanish=function(){s.remove()},this},activate:function(){return this._active=!0,this.flare("activated"),this},inactivate:function(){return this._active=!1,this.flare("inactivated"),this},onremoved:function(){this.instanceData[this.index+6]=0},update:function(t){var i=this.instanceData,e=this.index,a=this.runner;return a.update(),this.x=a.x,this.y=a.y,this.x<-100||SCREEN_WIDTH+100<this.x||this.y<-100||SCREEN_HEIGHT+100<this.y?void this.remove():(i[e+0]=this.x,i[e+1]=this.y,i[e+7]=1.5+.6*Math.sin(.2*this.age),void(this.age+=1))},hitPlayer:function(t){this.remove()}})}),phina.namespace(function(){phina.define("passion.BulletDrawer",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:2e3,init:function(t,i,e,a){this.superInit(t,i);var s=phigl.Program(t).attach("bullets.vs").attach("bullets.fs").link();this.setProgram(s).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vpMatrix","texture","globalScale");var n=this.instanceStride/4,r=phigl.Texture(t,"bullets.png");this.uniforms.texture.setValue(0).setTexture(r),this.uniforms.globalScale.setValue(1);for(var h=this.instanceData=[],o=0;o<this._count;o++)h.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(h);var l=this;this.pool=Array.range(0,this._count).map(function(t){return passion.Bullet(t,h,n).on("removed",function(){l.pool.add(this)})}).toPool(function(t,i){return t.id-i.id})},get:function(){return this.pool.get()},update:function(t){this.setInstanceAttributeData(this.instanceData)},render:function(t){var i=this.gl;i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.disable(i.DEPTH_TEST),this.uniforms.globalScale.value=1,t&&t.forIn(function(t,i){this.uniforms[t]&&(this.uniforms[t].value=i)}.bind(this)),this.draw(this._count)}})}),phina.namespace(function(){phina.define("passion.GLLayer",{superClass:"phina.display.Layer",static:{GL_CANVAS:null,GL:null},renderChildBySelf:!0,ready:!1,domElement:null,gl:null,camera:null,enemyDrawer:null,effectDrawer:null,bulletDrawer:null,playerDrawer:null,init:function(){this.superInit({width:GAME_AREA_WIDTH,height:GAME_AREA_HEIGHT}),this.originX=0,this.originY=0,null==passion.GLLayer.GL_CANVAS&&(passion.GLLayer.GL_CANVAS=document.createElement("canvas"),passion.GLLayer.GL=passion.GLLayer.GL_CANVAS.getContext("webgl")),this.domElement=passion.GLLayer.GL_CANVAS,this.domElement.width=this.width*passion.GLLayer.quality,this.domElement.height=this.height*passion.GLLayer.quality;var t=this.gl=passion.GLLayer.GL,i=phigl.Extensions.getInstancedArrays(t);t.viewport(0,0,this.domElement.width,this.domElement.height),t.clearColor(0,0,0,1),t.clearDepth(1),t.disable(t.CULL_FACE);var e=this.domElement.width,a=this.domElement.height,s=this.width,n=this.height;Math.pow(2,~~Math.log2(e)+1),Math.pow(2,~~Math.log2(a)+1);this.camera=passion.Camera().setPosition(.5*s,.5*n,2e3).lookAt(.5*s,.5*n,0).ortho(.5*-s,.5*s,.5*n,.5*-n,.1,3e3).calcVpMatrix(),this.enemyDrawer=passion.SpritDrawer(t,i,s,n),this.effectDrawer=passion.SpritDrawer(t,i,s,n),this.bulletDrawer=passion.BulletDrawer(t,i,s,n),this.playerDrawer=passion.SpritDrawer(t,i,s,n),this.ready=!0},update:function(t){this.ready&&(this.enemyDrawer.update(t),this.effectDrawer.update(t),this.bulletDrawer.update(t),this.playerDrawer.update(t))},draw:function(t){if(this.ready){var i=this.gl,e=this.domElement,a=e.width,s=e.height,n=this.camera.uniformValues();i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.enemyDrawer.render(n),this.effectDrawer.render(n),this.bulletDrawer.render(n),this.playerDrawer.render(n),i.flush(),t.context.drawImage(e,0,0,a,s,0,0,this.width,this.height)}},_static:{quality:1}})}),phina.namespace(function(){phina.define("passion.Player",{superClass:"passion.Sprite",init:function(t,i,e){this.superInit(t,i,e),this.on("enterframe",function(t){this.controll(t.app)})},spawn:function(){return passion.Sprite.prototype.spawn.call(this,{scaleX:5,scaleY:5,frameX:3/8,frameY:0,frameW:1/8,frameH:1/8}),this},controll:function(t){var i=t.pointer,e=i.deltaPosition;i.getPointing()&&(this.x+=2*e.x,this.y+=2*e.y,this.x=Math.clamp(this.x,5,GAME_AREA_WIDTH-5),this.y=Math.clamp(this.y,5,GAME_AREA_HEIGHT-5))}})}),phina.namespace(function(){phina.define("passion.SpritDrawer",{superClass:"phigl.InstancedDrawable",objTypes:null,objParameters:null,init:function(t,i,e,a){this.superInit(t,i),this.objTypes=[],this.objParameters={};var s=phigl.Program(t).attach("sprites.vs").attach("sprites.fs").link();this.setProgram(s).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-5,5,5,5,-5,-5,5,-5]},{unitSize:2,data:[0,1,1,1,0,0,1,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceColor").setUniforms("vpMatrix","texture","globalScale");this.instanceStride/4;this.uniforms.globalScale.setValue(1)},addObjType:function(t,i){if(i={}.$extend({className:"passion.Sprite",count:1,texture:null,additiveBlending:!1},i),!this.objTypes.contains(t)){var e=this.instanceStride/4;this.objTypes.push(t);var a=this.objParameters[t]={count:i.count,instanceVbo:phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW),texture:phigl.Texture(this.gl,i.texture),pool:null,additiveBlending:i.additiveBlending,instanceData:Array.range(i.count).map(function(t){return[0,1,0,0,0,1,0,0,0,1,0,0,0]}).flatten()},s=phina.using(i.className);a.pool=Array.range(i.count).map(function(t){return s(t,a.instanceData,e).on("removed",function(){a.pool.push(this)})})}},get:function(t){return this.objParameters[t].pool.shift()},update:function(){},render:function(t){var i=this.gl;i.enable(i.BLEND),i.disable(i.DEPTH_TEST),this.uniforms.globalScale.value=1,t&&t.forIn(function(t,i){this.uniforms[t]&&(this.uniforms[t].value=i)}.bind(this));var e=this;this.objTypes.forEach(function(t){var a=e.objParameters[t];a.additiveBlending?i.blendFunc(i.SRC_ALPHA,i.ONE):i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),e.setInstanceAttributeVbo(a.instanceVbo.set(a.instanceData)),e.uniforms.texture.setValue(0).setTexture(a.texture),e.draw(a.count)})}})}),phina.namespace(function(){phina.define("passion.Sprite",{superClass:"phina.app.Element",id:-1,instanceData:null,visible:!0,x:0,y:0,rotation:0,scale:0,frameX:0,frameY:0,frameW:0,frameH:0,red:1,green:1,blue:1,alpha:1,age:0,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.index=t*e},spawn:function(t){t.$safe({visible:!0,x:0,y:0,rotation:0,scaleX:1,scaleY:1,frameX:0,frameY:0,frameW:1/8,frameH:1/8,red:1,green:1,blue:1,alpha:1});var i=this.index,e=this.instanceData;return this.visible=t.visible,this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.frameX=t.frameX,this.frameY=t.frameY,this.frameW=t.frameW,this.frameH=t.frameH,this.red=t.red,this.green=t.green,this.blue=t.blue,this.alpha=t.alpha,e[i+0]=this.visible?1:0,e[i+1]=this.x,e[i+2]=this.y,e[i+3]=this.rotation,e[i+4]=this.scaleX,e[i+5]=this.scaleY,e[i+6]=this.frameX,e[i+7]=this.frameY,e[i+8]=this.frameW,e[i+9]=this.frameH,e[i+10]=this.red,e[i+11]=this.green,e[i+12]=this.blue,e[i+13]=this.alpha,this.age=0,this},update:function(t){var i=this.index,e=this.instanceData;e[i+0]=this.visible?1:0,e[i+1]=this.x,e[i+2]=this.y,e[i+3]=this.rotation,e[i+4]=this.scaleX,e[i+5]=this.scaleY,e[i+6]=this.frameX,e[i+7]=this.frameY,e[i+8]=this.frameW,e[i+9]=this.frameH,e[i+10]=this.red,e[i+11]=this.green,e[i+12]=this.blue,e[i+13]=this.alpha,this.age+=1},onremoved:function(){this.visible=!1,this.instanceData[this.index+0]=0}})}),phina.namespace(function(){phina.define("passion.Pool",{array:null,dirty:null,comparator:null,init:function(t,i){this.array=t||[],this.comparator=i||function(t,i){return t-i},this.dirty=!0},add:function(t){this.array.push(t),this.dirty=!0},get:function(){return this.dirty&&(this.array.sort(this.comparator),this.dirty=!1),this.array.shift()}}),Array.prototype.$method("toPool",function(t){return passion.Pool(this,t)})}),phina.namespace(function(){phina.define("passion.GameScene",{superClass:"phina.display.DisplayScene",init:function(){this.superInit();var t=phina.graphics.Canvas();t.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),t.clearColor("hsl(220, 70%, 20%)"),t.strokeStyle="hsl(220, 70%, 60%)",90..times(function(i,e){t.drawLine(0,SCREEN_HEIGHT/e*i,SCREEN_WIDTH,SCREEN_HEIGHT/e*i)}),60..times(function(i,e){t.drawLine(SCREEN_WIDTH/e*i,0,SCREEN_WIDTH/e*i,SCREEN_HEIGHT)}),this.fromJSON({children:{bg:{className:"phina.display.Sprite",arguments:t,originX:0,originY:0},glLayer:{className:"passion.GLLayer"},uiLayer:{className:"phina.display.DisplayElement",originX:0,originY:0}}}),this.glLayer.playerDrawer.addObjType("player",{className:"passion.Player",texture:"texture0.png"});var i=this.glLayer.playerDrawer.get("player");i.spawn(),i.addChildTo(this.glLayer),i.x=100,i.y=100}})});