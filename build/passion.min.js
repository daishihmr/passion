var SCREEN_WIDTH=360,SCREEN_HEIGHT=640,GAME_AREA_WIDTH=SCREEN_WIDTH,GAME_AREA_HEIGHT=.85*SCREEN_HEIGHT,FPS=60;phina.main(function(){phina.display.DisplayScene.defaults.$extend({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"transparent"}),phina.display.Label.defaults.fontFamily="main",phina.display.Label.defaults.fill="white";var t=passion.Application();"localhost"==location.hostname&&t.enableStats(),t.run(),t.replaceScene(phina.game.ManagerScene({scenes:[{className:"phina.game.LoadingScene",arguments:{assets:passion.Assets.get({assetType:"common"})}},{className:"passion.StageAssetLoadScene",arguments:{stage:"testStage"}},{className:"passion.GameScene"}]}))}),phina.namespace(function(){phina.define("passion.Application",{superClass:"phina.display.CanvasApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"#114"}),this.fps=FPS}})}),phina.namespace(function(){phina.define("passion.Assets",{_static:{get:function(t){switch(t.assetType){case"common":return{font:{main:"./asset/font/Baumans/Baumans-Regular.ttf",message:"./asset/font/YasashisaGothic.ttf"},image:{"bullets.png":"./asset/image/bullets.png","bullets_erase.png":"./asset/image/bullets_erase.png","texture0.png":"./asset/image/texture0.png"},vertexShader:{"bullets.vs":"./asset/shader/bullets.vs","sprites.vs":"./asset/shader/sprites.vs"},fragmentShader:{"bullets.fs":"./asset/shader/bullets.fs","sprites.fs":"./asset/shader/sprites.fs"},sound:{home:"./asset/sound/nc136160.mp3"}};default:throw"invalid assetType: "+t.assetType}}}})}),phina.namespace(function(){phina.define("passion.Camera",{position:null,vMatrix:null,pMatrix:null,vpMatrix:null,init:function(){this.position=vec3.create(),this.vMatrix=mat4.create(),this.pMatrix=mat4.create(),this.vpMatrix=mat4.create()},setPosition:function(t,e,i){return vec3.set(this.position,t,e,i),this},lookAt:function(t,e,i){return mat4.lookAt(this.vMatrix,this.position,[t,e,i],[0,1,0]),this},ortho:function(t,e,i,a,s,n){return mat4.ortho(this.pMatrix,t,e,i,a,s,n),this},perspective:function(t,e,i,a){return mat4.perspective(this.pMatrix,t,e,i,a),this},calcVpMatrix:function(){return mat4.mul(this.vpMatrix,this.pMatrix,this.vMatrix),this},uniformValues:function(){return{vpMatrix:this.vpMatrix,cameraPosition:this.position}}})}),phina.namespace(function(){phina.define("passion.Danmaku",{_static:{config:null,setup:function(t){var e=t.player,i=(t.bullets,t.enemies,t.glLayer),a=i.bulletDrawer;i.enemyDrawer;return bulletml.Walker.random=function(){return t.random.random()},this.config={target:e,createNewBullet:function(e,i){var s=a.get();s&&(s.spawn(e,{type:i.type,scale:32}),t.flare("spawnBullet",{bullet:s}))}},this.config},createRunner:function(t){var e=phina.asset.AssetManager.get("xml",t),i=bulletml.buildXML(e.data),a=passion.Danmaku.config;return i.createRunner(a)}},init:function(){}}),phina.asset.AssetLoader.assetLoadFunctions.bulletml=phina.asset.AssetLoader.assetLoadFunctions.xml}),phina.namespace(function(){phina.define("passion.Background",{superClass:"passion.Sprite",_static:{setup:function(t,e){var i=phina.asset.AssetManager.get("image",e),a=i.domElement.height*GAME_AREA_WIDTH/i.domElement.width,s=phina.graphics.Canvas().setSize(512,512);s.context.drawImage(i.domElement,0,0,512,512),phina.asset.AssetManager.set("image",e+"_bg",s),t.bgDrawer.addObjType("bg",{className:"passion.Background",texture:e+"_bg",count:2});var n=t.bgDrawer.get("bg");n.spawn(a),n.x=GAME_AREA_WIDTH/2,n.y=GAME_AREA_HEIGHT/2,n.addChildTo(t);var h=t.bgDrawer.get("bg");h.spawn(a),h.x=GAME_AREA_WIDTH/2,h.y=GAME_AREA_HEIGHT/2-a,h.addChildTo(t)}},height:0,init:function(t,e,i){this.superInit(t,e,i),this.on("enterframe",function(){this.y+=3,this.y>GAME_AREA_HEIGHT/2+this.height&&(this.y-=2*this.height)})},spawn:function(t){return this.height=t,passion.Sprite.prototype.spawn.call(this,{scaleX:GAME_AREA_WIDTH,scaleY:this.height,frameX:0,frameY:0,frameW:1,frameH:1,red:.5,green:.5,blue:.5}),this}})}),phina.namespace(function(){phina.define("passion.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,power:0,_active:!1,radius:20,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t,e){var i=this.instanceData,a=this.index;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,i[a+0]=this.x,i[a+1]=this.y,i[a+2]=t.direction,i[a+3]=e.scale,i[a+4]=e.type%8,i[a+5]=~~(e.type/8),i[a+6]=1,i[a+7]=1,i[a+8]=.2+~~(e.type/8)%2,i[a+9]=.2,i[a+10]=.2+~~(e.type/8)%2+1;var s=this;return t.onVanish=function(){s.remove()},this},activate:function(){return this._active=!0,this.flare("activated"),this},inactivate:function(){return this._active=!1,this.flare("inactivated"),this},onremoved:function(){this.instanceData[this.index+6]=0},update:function(t){var e=this.instanceData,i=this.index,a=this.runner;return a.update(),this.x=a.x,this.y=a.y,this.x<-50||GAME_AREA_WIDTH+50<this.x||this.y<-50||GAME_AREA_HEIGHT+50<this.y?void this.remove():(e[i+0]=this.x,e[i+1]=this.y,e[i+7]=1.5+.6*Math.sin(.2*this.age),void(this.age+=1))},isHit:function(t){return!(!this.visible||!t.visible)&&(this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)<25},_accessor:{visible:{get:function(){return 1==this.instanceData[this.index+6]},set:function(t){this.instanceData[this.index+6]=t?1:0}}}})}),phina.namespace(function(){phina.define("passion.BulletDrawer",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:300,init:function(t,e,i,a){this.superInit(t,e);var s=phigl.Program(t).attach("bullets.vs").attach("bullets.fs").link();this.setProgram(s).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-.5,.5,.5,.5,-.5,-.5,.5,-.5]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vpMatrix","texture","globalScale");var n=this.instanceStride/4,h=phigl.Texture(t,"bullets.png");this.uniforms.texture.setValue(0).setTexture(h),this.uniforms.globalScale.setValue(1);for(var r=this.instanceData=[],o=0;o<this._count;o++)r.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(r);var l=this;this.pool=Array.range(0,this._count).map(function(t){return passion.Bullet(t,r,n).on("removed",function(){l.pool.add(this)})}).toPool(function(t,e){return t.id-e.id})},get:function(){return this.pool.get()},update:function(t){this.setInstanceAttributeData(this.instanceData)},render:function(t){var e=this.gl;e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.uniforms.globalScale.value=1,t&&t.forIn(function(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}.bind(this)),this.draw(this._count)}})}),phina.namespace(function(){phina.define("passion.BulletEraseEffect",{superClass:"passion.Sprite",init:function(t,e,i){this.superInit(t,e,i),this.on("enterframe",function(t){t.app.ticker.frame%2===0&&(this.frameX+=1/8,this.frameX>=1&&this.remove())})},spawn:function(t){return passion.Sprite.prototype.spawn.call(this,{}.$extend(t,{frameX:0,frameY:1/8,frameW:1/8,frameH:1/8,scaleX:64,scaleY:64,alpha:1})),this}})}),phina.namespace(function(){phina.define("passion.CircleButton",{superClass:"phina.display.Shape",init:function(t){this.superInit({}.$extend(t,{width:2*t.radius,height:2*t.radius})),this.interactive=!0,this.boundingType="circle",this.radius=t.radius,this.backgroundColor="transparent",this.fill="hsla(190, 100%, 60%, 0.4)",this.stroke="hsla(190, 100%, 60%, 0.9)",this.strokeWidth=2,this.fromJSON({children:{text:{className:"phina.display.Label",arguments:{text:t.text,fontSize:t.fontSize||24,fontFamily:"main"},fill:"hsla(190, 100%, 95%, 0.8)",strokeWidth:0}}})},postrender:function(t){var e=t.context;e.strokeStyle="hsla(190, 100%, 60%, 0.8)",e.beginPath(),e.arc(0,0,.65*this.radius,0,2*Math.PI,!1),e.lineWidth=1,e.fill(),e.stroke(),e.beginPath(),e.arc(0,0,.75*this.radius,0,2*Math.PI,!1),e.lineWidth=3,e.stroke(),e.strokeStyle="hsla(190, 100%, 60%, 0.8)";for(var i,a=0;a<2*Math.PI;)i=Math.randfloat(1,2),e.beginPath(),e.arc(0,0,.9*this.radius,a,a+i,!1),e.lineWidth=1,e.stroke(),a+=1.5*i;e.strokeStyle="hsla(190, 100%, 60%, 0.8)";for(var i,a=0;a<2*Math.PI;)i=Math.randfloat(1,2),e.beginPath(),e.arc(0,0,1*this.radius,a,a+i,!1),e.lineWidth=1,e.stroke(),a+=1.5*i},onpointstart:function(t){this.scaleX=1.2,this.scaleY=1.2},onpointend:function(t){this.scaleX=1,this.scaleY=1,this.hitTest(t.pointer.x,t.pointer.y)&&this.flare("clicked")}})}),phina.namespace(function(){phina.define("passion.Enemy",{superClass:"passion.Sprite",motionRunner:null,attackRunner:null,status:-1,hp:0,active:!1,hitRadius:0,waitTime:0,bx:0,by:0,init:function(t,e,i){this.superInit(t,e,i),this.on("removed",function(){this.clear("damaged"),this.clear("killed"),this.tweener.clear(),this.motionRunner=null,this.attackRunner=null,this.status=-1,this.waitTime=0}),this.on("enterframe",function(){if(0===this.status)return this.waitTime-=1,void(this.waitTime<=0&&(this.status=1));if(1===this.status)this.hitRadius<this.x&&this.x<GAME_AREA_WIDTH-this.hitRadius&&this.hitRadius<this.y&&this.y<GAME_AREA_HEIGHT-this.hitRadius&&(this.status=2);else if((2===this.status||3===this.status)&&(this.x<-this.hitRadius||GAME_AREA_WIDTH+this.hitRadius<this.x||this.y<-this.hitRadius||GAME_AREA_HEIGHT+this.hitRadius<this.y))return void this.remove();this.motionRunner&&(this.bx=this.x,this.by=this.y,this.motionRunner.update(),this.x=this.motionRunner.x,this.y=this.motionRunner.y,this.rot&&(this.rotation=this.motionRunner.direction-.5*Math.PI)),(!this.rot||this.y<passion.Danmaku.config.target.y)&&this.attackRunner&&(this.attackRunner.x=this.x,this.attackRunner.y=this.y,this.attackRunner.update())})},spawn:function(t){return passion.Sprite.prototype.spawn.call(this,t),this.hp=t.hp||0,this.hitRadius=t.hitRadius||24,t.motion&&(this.motionRunner=passion.Danmaku.createRunner(t.motion),this.motionRunner.x=this.x,this.motionRunner.y=this.y),t.attack&&(this.attackRunner=passion.Danmaku.createRunner(t.attack),this.attackRunner.x=this.x,this.attackRunner.y=this.y),this.hp=t.hp,this.status=0,this.waitTime=t.wait||0,this.rot=t.rot||!1,this.on("damage",function(t){var e=t.shot;this.hp-=e.power,this.hp<=0&&this.flare("killed")}),this.on("killed",function(t){this.remove()}),this},isHit:function(t){return!(!t.visible||2!=this.status||this.hp<=0)&&(this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)<this.hitRadius*this.hitRadius}})}),phina.namespace(function(){phina.define("passion.GLLayer",{superClass:"phina.display.Layer",static:{GL_CANVAS:null,GL:null},renderChildBySelf:!0,ready:!1,domElement:null,gl:null,camera:null,bgDrawer:null,enemyDrawer:null,shotDrawer:null,effectDrawer:null,playerDrawer:null,bulletDrawer:null,topEffectDrawer:null,init:function(){this.superInit({width:GAME_AREA_WIDTH,height:GAME_AREA_HEIGHT}),this.originX=0,this.originY=0,null==passion.GLLayer.GL_CANVAS&&(passion.GLLayer.GL_CANVAS=document.createElement("canvas"),passion.GLLayer.GL=passion.GLLayer.GL_CANVAS.getContext("webgl")),this.domElement=passion.GLLayer.GL_CANVAS,this.domElement.width=this.width*passion.GLLayer.quality,this.domElement.height=this.height*passion.GLLayer.quality;var t=this.gl=passion.GLLayer.GL,e=phigl.Extensions.getInstancedArrays(t);t.viewport(0,0,this.domElement.width,this.domElement.height),t.clearColor(0,0,0,1),t.clearDepth(1),t.disable(t.CULL_FACE),t.enable(t.BLEND),t.disable(t.DEPTH_TEST);var i=this.domElement.width,a=this.domElement.height,s=this.width,n=this.height;Math.pow(2,~~Math.log2(i)+1),Math.pow(2,~~Math.log2(a)+1);this.camera=passion.Camera().setPosition(.5*s,.5*n,2e3).lookAt(.5*s,.5*n,0).ortho(.5*-s,.5*s,.5*n,.5*-n,.1,3e3).calcVpMatrix(),this.bgDrawer=passion.SpritDrawer(t,e,s,n),this.enemyDrawer=passion.SpritDrawer(t,e,s,n),this.shotDrawer=passion.SpritDrawer(t,e,s,n),this.effectDrawer=passion.SpritDrawer(t,e,s,n),this.playerDrawer=passion.SpritDrawer(t,e,s,n),this.bulletDrawer=passion.BulletDrawer(t,e,s,n),this.topEffectDrawer=passion.SpritDrawer(t,e,s,n),this.ready=!0},update:function(t){this.ready&&(this.bgDrawer.update(t),this.enemyDrawer.update(t),this.shotDrawer.update(t),this.effectDrawer.update(t),this.playerDrawer.update(t),this.bulletDrawer.update(t),this.topEffectDrawer.update(t))},draw:function(t){if(this.ready){var e=this.gl,i=this.domElement,a=i.width,s=i.height,n=this.camera.uniformValues();e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.bgDrawer.render(n),this.effectDrawer.render(n),this.enemyDrawer.render(n),this.shotDrawer.render(n),this.playerDrawer.render(n),this.bulletDrawer.render(n),this.topEffectDrawer.render(n),e.flush();var h=passion.GLLayer.padding;t.context.drawImage(i,0,0,a,s,this.width*h,this.height*h,this.width*(1-2*h),this.height*(1-2*h))}},_static:{padding:.01,quality:.75}})}),phina.namespace(function(){phina.define("passion.ParticleEmitter",{superClass:"phina.display.Element",x:0,y:0,glLayer:null,drawer:null,objName:null,spawnOptions:null,genPerFrame:0,init:function(t,e,i,a){this.superInit(),this.glLayer=t,this.drawer=e,this.objName=i,this.spawnOptions=a},update:function(t){for(var e=0;e<this.genPerFrame;e++){var i=this.drawer.get(this.objName);if(!i)break;i.spawn({}.$extend(this.spawnOptions,{x:this.x,y:this.y})),i.addChildTo(this.glLayer)}}}),phina.define("passion.Particle",{superClass:"passion.Sprite",init:function(t,e,i){this.superInit(t,e,i),this.on("removed",function(){this.clear("enterframe"),this.tweener.clear()})}})}),phina.namespace(function(){phina.define("passion.Player",{superClass:"passion.Sprite",_static:{setup:function(t){t.playerDrawer.addObjType("player",{className:"passion.Player",texture:"texture0.png"});var e=t.playerDrawer.get("player");e.spawn(),e.on("enterframe",function(i){if(i.app.ticker.frame%2===0){var a=t.effectDrawer.get("effect"),s=t.effectDrawer.get("effect"),n={x:e.x-8,y:e.y+15,scaleX:18,scaleY:18,frameX:7/8,frameY:0,frameW:1/8,frameH:1/8,red:1,green:1,blue:1,alpha:1},h=function(){this.y+=2,this.alpha*=.8,this.alpha<.01&&this.remove()};a&&(n.x=e.x-8,a.spawn(n),a.onenterframe=h,a.addChildTo(t)),s&&(n.x=e.x+8,s.spawn(n),s.onenterframe=h,s.addChildTo(t))}});var i=t.effectDrawer.get("effect");i.spawn({x:e.x,y:e.y,scaleX:80,scaleY:80,frameX:0,frameY:1/8,frameW:1/8,frameH:1/8,red:2,green:2,blue:2,alpha:.2}),i.addChildTo(t),i.on("enterframe",function(){this.x=e.x,this.y=e.y});var a=t.topEffectDrawer.get("effect");return a.spawn({x:e.x,y:e.y,scaleX:14,scaleY:14,frameX:7/8,frameY:0,frameW:1/8,frameH:1/8,red:.4,green:2,blue:1.6,alpha:1}),a.addChildTo(e),a.on("enterframe",function(){this.x=e.x,this.y=e.y,this.rotation+=.1}),e}},_roll:0,heat:0,heatByShot:0,init:function(t,e,i){this.superInit(t,e,i),this.on("enterframe",function(t){this.controll(t.app)})},spawn:function(){return passion.Sprite.prototype.spawn.call(this,{x:.5*GAME_AREA_WIDTH,y:.9*GAME_AREA_HEIGHT,scaleX:64,scaleY:64,frameX:3/8,frameY:0,frameW:1/8,frameH:1/8,red:1.2,green:1.2,blue:1.2}),this},controll:function(t){var e=t.pointer,i=e.deltaPosition;(phina.isMobile()||!phina.isMobile()&&e.getPointing())&&(this.x+=2*i.x,this.y+=2*i.y,i.x<0?this.roll-=.2:0<i.x&&(this.roll+=.2),this.x=Math.clamp(this.x,5,GAME_AREA_WIDTH-5),this.y=Math.clamp(this.y,40,GAME_AREA_HEIGHT-5)),0==i.x&&(this.roll*=.9,-.01<this.roll&&this.roll<.01&&(this.roll=0));var a=!phina.isMobile()&&e.getPointing()||phina.isMobile()&&t.pointers.length>0;a&&this.heat<=0&&(this.flare("fireShot"),this.heat=this.heatByShot),this.heat-=1},_accessor:{roll:{get:function(){return this._roll},set:function(t){this._roll=Math.clamp(t,-3,3);var e=~~this._roll;this.frameX=(e+3)/8}}}})}),phina.namespace(function(){var t=20;phina.define("passion.Shot",{superClass:"passion.Sprite",bx:0,by:0,power:0,init:function(t,e,i){this.superInit(t,e,i),this.on("enterframe",function(t){this.bx=this.x,this.by=this.y,this.controll(t.app)})},controll:function(t){},onhit:function(t){this.remove()}}),phina.define("passion.NormalShot",{superClass:"passion.Shot",_static:{heatByShot:6,fireCount:3},init:function(t,e,i){this.superInit(t,e,i),this.power=1},spawn:function(t,e){return passion.Shot.prototype.spawn.call(this,{x:t.x+10*[-1,1,0][e],y:t.y-30,rotation:.5*-Math.PI,scaleX:48,scaleY:48,frameX:1/8,frameY:1/8,frameW:1/8,frameH:1/8,red:1,green:1,blue:1,alpha:.8}),this},controll:function(e){this.y-=t,this.y<GAME_AREA_HEIGHT*-.1&&this.remove()}}),phina.define("passion.WideShot",{superClass:"passion.Shot",_static:{heatByShot:6,fireCount:3},init:function(t,e,i){this.superInit(t,e,i),this.power=1},spawn:function(e,i){return passion.Shot.prototype.spawn.call(this,{x:e.x+20*[-1,1,0][i],y:e.y,rotation:.5*-Math.PI+.2*[-1,1,0][i],scaleX:48,scaleY:48,frameX:1/8,frameY:1/8,frameW:1/8,frameH:1/8,red:1,green:1,blue:1,alpha:.8}),this.dx=Math.cos(this.rotation)*t,this.dy=Math.sin(this.rotation)*t,this},controll:function(t){this.x+=this.dx,this.y+=this.dy,(this.y<GAME_AREA_HEIGHT*-.1||this.x<GAME_AREA_WIDTH*-.1||1.1*GAME_AREA_WIDTH<this.x)&&this.remove()}})}),phina.namespace(function(){phina.define("passion.SpritDrawer",{superClass:"phigl.InstancedDrawable",objTypes:null,objParameters:null,init:function(t,e,i,a){this.superInit(t,e),this.objTypes=[],this.objParameters={};var s=phigl.Program(t).attach("sprites.vs").attach("sprites.fs").link();this.setProgram(s).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-.5,.5,.5,.5,-.5,-.5,.5,-.5]},{unitSize:2,data:[0,1,1,1,0,0,1,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceColor").setUniforms("vpMatrix","texture","globalScale");this.instanceStride/4;this.uniforms.globalScale.setValue(1)},addObjType:function(t,e){if(e={}.$extend({className:"passion.Sprite",count:1,texture:null,additiveBlending:!1},e),!this.objTypes.contains(t)){var i=this.instanceStride/4;this.objTypes.push(t);var a=this.objParameters[t]={count:e.count,instanceVbo:phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW),texture:phigl.Texture(this.gl,e.texture),pool:null,additiveBlending:e.additiveBlending,instanceData:Array.range(e.count).map(function(t){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0]}).flatten()},s=phina.using(e.className);a.pool=Array.range(e.count).map(function(t){return s(t,a.instanceData,i).on("removed",function(){a.pool.push(this)})})}},get:function(t){return this.objParameters[t].pool.shift()},update:function(){},render:function(t){if(0!==this.objTypes.length){var e=this.gl;this.uniforms.globalScale.value=1,t&&t.forIn(function(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}.bind(this));var i=this;this.objTypes.forEach(function(t){var a=i.objParameters[t];a.additiveBlending?e.blendFunc(e.SRC_ALPHA,e.ONE):e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),i.setInstanceAttributeVbo(a.instanceVbo.set(a.instanceData)),i.uniforms.texture.setValue(0).setTexture(a.texture),i.draw(a.count)})}}})}),phina.namespace(function(){phina.define("passion.Sprite",{superClass:"phina.app.Element",id:-1,instanceData:null,visible:!0,x:0,y:0,rotation:0,scale:0,frameX:0,frameY:0,frameW:0,frameH:0,red:1,green:1,blue:1,alpha:1,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t){t.$safe({visible:!0,x:0,y:0,rotation:0,scaleX:1,scaleY:1,frameX:0,frameY:0,frameW:1/8,frameH:1/8,red:1,green:1,blue:1,alpha:1});var e=this.index,i=this.instanceData;return this.visible=t.visible,this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.frameX=t.frameX,this.frameY=t.frameY,this.frameW=t.frameW,this.frameH=t.frameH,this.red=t.red,this.green=t.green,this.blue=t.blue,this.alpha=t.alpha,i[e+0]=this.visible?1:0,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scaleX,i[e+5]=this.scaleY,i[e+6]=this.frameX,i[e+7]=this.frameY,i[e+8]=this.frameW,i[e+9]=this.frameH,i[e+10]=this.red,i[e+11]=this.green,i[e+12]=this.blue,i[e+13]=this.alpha,this.age=0,this},update:function(t){var e=this.index,i=this.instanceData;i[e+0]=this.visible?1:0,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scaleX,i[e+5]=this.scaleY,i[e+6]=this.frameX,i[e+7]=this.frameY,i[e+8]=this.frameW,i[e+9]=this.frameH,i[e+10]=this.red,i[e+11]=this.green,i[e+12]=this.blue,i[e+13]=this.alpha,this.age+=1},onremoved:function(){this.visible=!1,this.instanceData[this.index+0]=0}})}),phina.namespace(function(){phina.define("passion.UIFrame",{superClass:"phina.display.Shape",init:function(t){this.superInit(t),this.backgroundColor="transparent",this.strokeWidth=2},prerender:function(t){var e=t.context;e.beginPath(),e.moveTo(-this.width/2+10,-this.height/2),e.lineTo(this.width/2-5,-this.height/2),e.lineTo(this.width/2,-this.height/2+5),e.lineTo(this.width/2,this.height/2-10),e.lineTo(this.width/2-10,this.height/2),e.lineTo(-this.width/2+35,this.height/2),e.lineTo(-this.width/2+30,this.height/2-5),e.lineTo(-this.width/2,this.height/2-5),e.lineTo(-this.width/2,10-this.height/2),e.closePath();var i=e.createLinearGradient(this.height/2,-this.width/2,-this.height/2,this.width/2);i.addColorStop(0,"hsla(190, 100%, 30%, 0.8)"),i.addColorStop(.38,"hsla(190, 100%, 30%, 0.8)"),i.addColorStop(.48,"hsla(190, 100%, 80%, 0.8)"),i.addColorStop(.52,"hsla(190, 100%, 80%, 0.8)"),i.addColorStop(.62,"hsla(190, 100%, 30%, 0.8)"),i.addColorStop(1,"hsla(190, 100%, 30%, 0.8)"),this.stroke=i;var a=e.createLinearGradient(this.height/2,-this.width/2,-this.height/2,this.width/2);a.addColorStop(0,"hsla(210, 100%, 30%, 0.2)"),a.addColorStop(.38,"hsla(210, 100%, 30%, 0.2)"),a.addColorStop(.48,"hsla(210, 100%, 80%, 0.2)"),a.addColorStop(.52,"hsla(210, 100%, 80%, 0.2)"),a.addColorStop(.62,"hsla(210, 100%, 30%, 0.2)"),a.addColorStop(1,"hsla(210, 100%, 30%, 0.2)"),this.fill=a},postrender:function(t){var e=t.context;e.beginPath(),e.moveTo(-this.width/2+10-3,-this.height/2-3),e.lineTo(this.width/2-5+3,-this.height/2-3),e.lineTo(this.width/2+3,-this.height/2+5-3),e.lineTo(this.width/2+3,this.height/2-10+3),e.lineTo(this.width/2-10+3,this.height/2+3),e.lineTo(-this.width/2+35-3,this.height/2+3),e.lineTo(-this.width/2+30-3,this.height/2-5+3),e.lineTo(-this.width/2-3,this.height/2-5+3),e.lineTo(-this.width/2-3,-this.height/2+10-3),e.closePath(),e.lineWidth=1,e.stroke()}})}),phina.namespace(function(){phina.define("passion.UIHeadLabel",{superClass:"phina.display.Shape",init:function(t){this.superInit(t),this.backgroundColor="transparent",this.stroke="hsla(190, 100%, 60%, 1.0)",this.strokeWidth=1,this.fromJSON({children:{text:{className:"phina.display.Label",arguments:{text:t.text,fontSize:t.fontSize||24,fontFamily:t.fontFamily||"main",align:t.align||"center"},fill:"hsla(190, 100%, 95%, 0.8)",strokeWidth:0}}})},prerender:function(t){var e=t.context,i=e.createLinearGradient(0,-this.height/2,0,this.height/2);i.addColorStop(0,"hsla(190, 100%, 50%, 0.2)"),i.addColorStop(.4,"hsla(190, 100%, 30%, 0.2)"),i.addColorStop(.6,"hsla(190, 100%, 30%, 0.2)"),i.addColorStop(1,"hsla(190, 100%, 50%, 0.2)"),this.fill=i},postrender:function(t){var e=t.context;e.beginPath(),e.moveTo(-this.width/2,this.height/2),e.lineTo(-this.width/2,-this.height/2+10),e.lineTo(-this.width/2+10,-this.height/2),e.lineTo(this.width/2,-this.height/2),e.lineTo(this.width/2,this.height/2-10),e.lineTo(this.width/2-10,this.height/2),e.closePath(),e.fill(),e.beginPath(),e.moveTo(-this.width/2,this.height/2),e.lineTo(-this.width/2,-this.height/2+10),e.lineTo(-this.width/2+10,-this.height/2),e.stroke(),e.beginPath(),e.moveTo(this.width/2,-this.height/2),e.lineTo(this.width/2,this.height/2-10),e.lineTo(this.width/2-10,this.height/2),e.stroke()}})}),phina.namespace(function(){phina.define("passion.UIHead2Label",{superClass:"phina.display.Shape",init:function(t){this.superInit(t),this.backgroundColor="transparent",this.strokeWidth=1,this.fromJSON({children:{text:{className:"phina.display.Label",arguments:{text:t.text,fontSize:t.fontSize||24,fontFamily:t.fontFamily||"main",align:t.align||"center"},fill:"hsla(190, 100%, 95%, 0.8)",strokeWidth:0}}})},prerender:function(t){var e=t.context,i=e.createLinearGradient(0,-this.height/2,0,this.height/2);i.addColorStop(0,"hsla(190, 100%, 50%, 0.2)"),i.addColorStop(.4,"hsla(190, 100%, 30%, 0.2)"),i.addColorStop(.6,"hsla(190, 100%, 30%, 0.2)"),i.addColorStop(1,"hsla(190, 100%, 50%, 0.2)"),this.fill=i;var a=e.createLinearGradient(-this.width/2,0,this.width/2,0);a.addColorStop(0,"hsla(190, 100%, 60%, 0.0)"),a.addColorStop(.3,"hsla(190, 100%, 60%, 1.0)"),a.addColorStop(.7,"hsla(190, 100%, 60%, 1.0)"),a.addColorStop(1,"hsla(190, 100%, 60%, 0.0)"),this.stroke=a},postrender:function(t){var e=t.context;e.beginPath(),e.moveTo(-this.width/2,this.height/2),e.lineTo(-this.width/2,-this.height/2),e.lineTo(this.width/2,-this.height/2),e.lineTo(this.width/2,this.height/2),e.closePath(),e.fill(),e.beginPath(),e.moveTo(-this.width/2,this.height/2),e.lineTo(this.width/2,this.height/2),e.stroke(),e.beginPath(),e.moveTo(-this.width/2,-this.height/2),e.lineTo(this.width/2,-this.height/2),e.stroke()}})}),phina.namespace(function(){phina.define("passion.UILayer",{superClass:"phina.display.DisplayElement",init:function(t){this.superInit(),this.fromJSON({originX:0,originY:0,children:{damage:{className:"phina.display.Sprite",arguments:this.damageTexture(),originX:0,originY:0,alpha:0,x:GAME_AREA_WIDTH*passion.GLLayer.padding,y:GAME_AREA_HEIGHT*passion.GLLayer.padding},scoreBg:{className:"passion.UIFrame",arguments:{width:.96*SCREEN_WIDTH,height:.05*SCREEN_HEIGHT},x:0*SCREEN_WIDTH,y:0*SCREEN_HEIGHT,originX:0,originY:0,children:{scoreLabel:{className:"phina.display.Label",arguments:{text:"9,991,234,567,890",align:"right",baseline:"middle",fontSize:.035*SCREEN_HEIGHT},x:.96*SCREEN_WIDTH,y:.038*SCREEN_HEIGHT},hi:{className:"phina.display.Label",arguments:{text:"HI",align:"left",baseline:"middle",fontSize:.025*SCREEN_HEIGHT},x:.04*SCREEN_WIDTH,y:.035*SCREEN_HEIGHT},highscoreLabel:{className:"phina.display.Label",arguments:{text:"9,991,234,567,890",align:"right",baseline:"middle",fontSize:.025*SCREEN_HEIGHT},x:.44*SCREEN_WIDTH,y:.035*SCREEN_HEIGHT}}},messageWindow:{className:"passion.UIFrame",arguments:{width:.96*SCREEN_WIDTH,height:.14*SCREEN_HEIGHT},x:0*SCREEN_WIDTH,y:.84*SCREEN_HEIGHT,originX:0,originY:0,children:{nameLabel:{className:"passion.UIHead2Label",arguments:{text:"オペ子",width:.3*SCREEN_WIDTH,height:.03*SCREEN_HEIGHT,fontSize:18,fontFamily:"main, message"},x:.2*SCREEN_WIDTH,y:.034*SCREEN_HEIGHT,visible:!1},mesasgeLabel:{className:"phina.display.Label",arguments:{text:"WARNING!!\n今までにない強大な力が近づいてきます！\n気をつけてください！！",align:"left",baseline:"top",fontSize:16,lineHeight:1.1,fontFamily:"main, message"},x:.05*SCREEN_WIDTH,y:.076*SCREEN_HEIGHT,visible:!1}}},bombButton:{className:"passion.CircleButton",arguments:{text:"BOMB",fontSize:15,radius:.09*GAME_AREA_WIDTH},x:.12*GAME_AREA_WIDTH,y:.92*GAME_AREA_HEIGHT}}});var e=this;t.on("updateScore",function(){e.scoreBg.scoreLabel.text=passion.Utils.sep(this.score),this.highScore<this.score&&(e.scoreBg.highscoreLabel.text=passion.Utils.sep(this.highScore))}),t.on("damage",function(t){})},damageTexture:function(){var t=phina.graphics.Canvas(),e=passion.GLLayer.padding;t.setSize(GAME_AREA_WIDTH*(1-2*e),GAME_AREA_HEIGHT*(1-2*e)),t.clearColor("transparent");var i=t.context.createRadialGradient(t.width/2,t.height/2,0,t.width/2,t.height/2,t.height/2);return i.addColorStop(0,"rgba(255, 0, 0, 0.0)"),i.addColorStop(1,"rgba(255, 0, 0, 1.0)"),t.fillStyle=i,t.fillRect(0,0,t.width,t.height),t}})}),phina.namespace(function(){phina.define("passion.GameSceneBg",{_static:{drawBgTexture:function(){var t=phina.graphics.Canvas();return t.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),t.clearColor("hsla(190, 100%, 95%, 0.05)"),150..times(function(e,i){var a=1.5*SCREEN_HEIGHT/i*e;t.strokeStyle="hsla(190, 100%, 95%, 0.1)",t.strokeLines(0*SCREEN_WIDTH,a-10,.1*SCREEN_WIDTH,a-10,.2*SCREEN_WIDTH,a+20,.5*SCREEN_WIDTH,a+20,.6*SCREEN_WIDTH,a-30,.7*SCREEN_WIDTH,a-30,.8*SCREEN_WIDTH,a-50,1*SCREEN_WIDTH,a-50),t.strokeStyle="hsla(190, 100%, 65%, 0.1)",a+=1,t.strokeLines(0*SCREEN_WIDTH,a-10,.1*SCREEN_WIDTH,a-10,.2*SCREEN_WIDTH,a+20,.5*SCREEN_WIDTH,a+20,.6*SCREEN_WIDTH,a-30,.7*SCREEN_WIDTH,a-30,.8*SCREEN_WIDTH,a-50,1*SCREEN_WIDTH,a-50),t.strokeStyle="hsla(190, 100%, 35%, 0.1)",a+=1,t.strokeLines(0*SCREEN_WIDTH,a-10,.1*SCREEN_WIDTH,a-10,.2*SCREEN_WIDTH,a+20,.5*SCREEN_WIDTH,a+20,.6*SCREEN_WIDTH,a-30,.7*SCREEN_WIDTH,a-30,.8*SCREEN_WIDTH,a-50,1*SCREEN_WIDTH,a-50)}),t}},init:function(){}})}),phina.namespace(function(){phina.define("passion.GameManager",{superClass:"phina.util.EventDispatcher",score:0,highScore:0,frame:0,waitTo:0,timeline:null,init:function(t){this.superInit(),this.timeline=t.timeline,this.waitTo=-1},update:function(t){for(;(this.waitTo===this.frame||this.waitTo===-1)&&this.timeline.length>0;){this.waitTo=-1;var e=this.timeline.shift();console.log("[task] "+this.frame+" "+e.type),this[e.type](e.arguments)}this.frame+=1},startBgm:function(t){},stopBgm:function(){},wait:function(t){this.waitTo=this.frame+t.time},enemy:function(t){this.flare("spawnEnemy",t)},enemyGroup:function(t){var e;e="string"==typeof t.enemy?{name:e}:t.enemy;for(var i=0;i<t.count;i++)this.flare("spawnEnemy",{}.$extend(e,{x:(t.x||0)+(t.dx||0)*i,y:(t.y||0)+(t.dy||0)*i,wait:(t.wait||0)+(t.dwait||0)*i}))},warning:function(t){},boss:function(t){}})}),phina.namespace(function(){phina.define("passion.Pool",{array:null,dirty:null,comparator:null,init:function(t,e){this.array=t||[],this.comparator=e||function(t,e){return t-e},this.dirty=!0},add:function(t){this.array.push(t),this.dirty=!0},get:function(){return this.dirty&&(this.array.sort(this.comparator),this.dirty=!1),this.array.shift()}}),Array.prototype.$method("toPool",function(t){return passion.Pool(this,t)})}),phina.namespace(function(){phina.define("passion.GameScene",{superClass:"phina.display.DisplayScene",random:null,gameManager:null,shots:null,enemies:null,bullets:null,items:null,init:function(t){this.superInit(t);var e=phina.asset.AssetManager.get("json","stage").data;this.random=phina.util.Random(12345),this.gameManager=passion.GameManager(e),this.fromJSON({shots:[],enemies:[],bullets:[],items:[],children:{bg:{className:"phina.display.Sprite",arguments:passion.GameSceneBg.drawBgTexture(),originX:0,originY:0},glLayer:{className:"passion.GLLayer"},uiLayer:{className:"passion.UILayer",arguments:this.gameManager,alpha:0}}}),this.uiLayer.tweener.clear().fadeIn(500);var i=this.gameManager,a=this.glLayer;a.effectDrawer.addObjType("effect",{texture:"texture0.png",additiveBlending:!0,count:200}),a.topEffectDrawer.addObjType("bullets_erase",{className:"passion.BulletEraseEffect",texture:"bullets_erase.png",count:200}),a.topEffectDrawer.addObjType("effect",{texture:"texture0.png",count:2}),passion.Background.setup(a,"bg",1069);var s=this.player=passion.Player.setup(a).addChildTo(a),n="passion.WideShot";a.shotDrawer.addObjType("shot",{className:n,texture:"bullets.png",count:50});var h=phina.using(n);s.heatByShot=h.heatByShot;var r=this.shots;s.on("fireShot",function(t){for(var e=0;e<h.fireCount;e++){var i=a.shotDrawer.get("shot");i&&(i.spawn(this,e).addChildTo(a),r.push(i))}}),a.shotDrawer.objParameters.shot.pool.forEach(function(t){t.on("removed",function(){var t=a.topEffectDrawer.get("bullets_erase");t&&t.spawn({x:this.x,y:this.y,frameY:1/8}).addChildTo(a),r.erase(this)})}),e.enemies.map(function(t){return phina.asset.AssetManager.get("json",t+".enemy").data}).map(function(t){return t.texture}).uniq().forEach(function(t){a.enemyDrawer.addObjType(t,{className:"passion.Enemy",texture:t,count:50}),a.enemyDrawer.objParameters[t].pool.forEach(function(t){t.on("removed",function(){o.erase(this)})})});var o=this.enemies;i.on("spawnEnemy",function(t){var e=phina.asset.AssetManager.get("json",t.name+".enemy").data,i=a.enemyDrawer.get(e.texture);i&&(i.spawn({}.$extend(e,t,{x:t.x*GAME_AREA_WIDTH,y:t.y*GAME_AREA_HEIGHT})),i.addChildTo(a),o.push(i))}),passion.Danmaku.setup(this);var l=this.bullets;this.on("spawnBullet",function(t){var e=t.bullet;e.addChildTo(a),l.push(e)}),a.bulletDrawer.pool.array.forEach(function(t){
t.on("removed",function(){l.erase(this)}),t.on("erased",function(){var t=a.topEffectDrawer.get("bullets_erase");t&&t.spawn({x:this.x,y:this.y,frameY:0}).addChildTo(a)})})},update:function(t){this.gameManager.update(t),this._hitTest()},_hitTest:function(){this._hitTestItemPlayer(),this._hitTestEnemyShot(),this._hitTestEnemyPlayer(),this._hitTestBulletPlayer()},_hitTestItemPlayer:function(){},_hitTestEnemyShot:function(){for(var t=this.enemies.clone(),e=this.shots.clone(),i=0;i<t.length;i++)for(var a=t[i],s=0;s<e.length;s++){var n=e[s];a.isHit(n)&&(a.flare("damage",{shot:n}),n.flare("hit"))}},_hitTestEnemyPlayer:function(){for(var t=this.enemies.clone(),e=this.player,i=0;i<t.length;i++)t[i].isHit(e)&&t[i].remove()},_hitTestBulletPlayer:function(){for(var t=this.bullets.clone(),e=this.player,i=0;i<t.length;i++)t[i].isHit(e)&&t[i].remove()},eraseAllBullets:function(){this.bullets.clone().forEach(function(t){t.flare("erased"),t.remove()})},onspawnItem:function(t){var e=t.item;e.addChildTo(this.glLayer),this.items.push(e)}})}),phina.namespace(function(){phina.define("passion.StageAssetLoadScene",{superClass:"phina.display.DisplayScene",init:function(t){this.superInit(t),this.fromJSON({children:{bg0:{className:"phina.display.Sprite",arguments:passion.GameSceneBg.drawBgTexture(),originX:0,originY:0},bg1:{className:"phina.display.RectangleShape",arguments:{fill:"black",stroke:null,width:SCREEN_WIDTH,height:.1*SCREEN_HEIGHT},x:.5*SCREEN_WIDTH,y:.5*SCREEN_HEIGHT},label:{className:"phina.display.Label",arguments:{text:""},x:.5*SCREEN_WIDTH,y:.5*SCREEN_HEIGHT,alpha:0}}});var e=t.stage,i=phina.asset.AssetLoader();i.load({json:{stage:"./asset/stage/"+e+".json"}}),this.label.tweener.fadeIn(1e3),i.on("load",function(){this.step1()}.bind(this)),this.label.text="step0"},update:function(t){var e=Math.floor(.1*t.ticker.frame)%4,i="downloading";e.times(function(){i+="."}),i.paddingRight("downloading".length+3," ")},step1:function(){var t=phina.asset.AssetManager.get("json","stage").data,e={};t.enemies.forEach(function(t){e[t+".enemy"]="./asset/enemy/"+t+".json"});var i=phina.asset.AssetLoader();i.load({json:e,sound:{bgm:"./asset/sound/"+t.bgm+".mp3"},image:{bg:"./asset/image/"+t.bg+".png"}}),i.on("load",function(){this.step2(t)}.bind(this)),this.label.text="step1"},step2:function(t){var e={};t.enemies.map(function(t){return phina.asset.AssetManager.get("json",t+".enemy").data}).map(function(t){return t.texture}).uniq().forEach(function(t){e[t]="./asset/image/"+t+".png"});var i=phina.asset.AssetLoader();i.load({image:e}),i.on("load",function(){this.step3(t)}.bind(this)),this.label.text="step2"},step3:function(t){var e={};t.enemies.map(function(t){return phina.asset.AssetManager.get("json",t+".enemy").data}).forEach(function(t){t.motion&&(e[t.motion]="./asset/bulletml/"+t.motion+".xml"),t.attack&&(e[t.attack]="./asset/bulletml/"+t.attack+".xml")}),t.timeline.forEach(function(t){t.arguments.motion&&(e[t.arguments.motion]="./asset/bulletml/"+t.arguments.motion+".xml"),t.arguments.attack&&(e[t.arguments.attack]="./asset/bulletml/"+t.arguments.attack+".xml"),t.arguments.enemy&&(t.arguments.enemy.motion&&(e[t.arguments.enemy.motion]="./asset/bulletml/"+t.arguments.enemy.motion+".xml"),t.arguments.enemy.attack&&(e[t.arguments.enemy.attack]="./asset/bulletml/"+t.arguments.enemy.attack+".xml"))});var i=phina.asset.AssetLoader();i.load({xml:e}),i.on("load",function(){this.label.tweener.clear().fadeOut(100),this.bg1.tweener.fadeOut(500).call(function(){this.app.popScene()}.bind(this))}.bind(this)),this.label.text="step3"}})}),phina.namespace(function(){phina.define("passion.Utils",{_static:{sep:function(t){return(""+Math.floor(t)).replace(/(\d)(?=(\d{3})+$)/g,"$1,")}},init:function(){}}),phina.accessory.Tweener.$method("clone",function(){return phina.accessory.Tweener(this.target)})});