var SCREEN_WIDTH=360,SCREEN_HEIGHT=640,GAME_AREA_WIDTH=SCREEN_WIDTH,GAME_AREA_HEIGHT=.85*SCREEN_HEIGHT,FPS=60;phina.main(function(){phina.display.DisplayScene.defaults.$extend({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"transparent"});var t=passion.Application();t.enableStats(),t.run(),t.replaceScene(phina.game.ManagerScene({scenes:[{className:"phina.game.LoadingScene",arguments:{assets:passion.Assets.get({assetType:"common"})}},{className:"passion.GameScene"}]}))}),phina.namespace(function(){phina.define("passion.Application",{superClass:"phina.display.CanvasApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"#114"}),this.fps=FPS}})}),phina.namespace(function(){phina.define("passion.Assets",{_static:{get:function(t){switch(t.assetType){case"common":return{image:{"test.png":"./asset/image/test.png","bullets.png":"./asset/image/bullets.png","texture0.png":"./asset/image/texture0.png"},vertexShader:{"bullets.vs":"./asset/shader/bullets.vs","sprites.vs":"./asset/shader/sprites.vs"},fragmentShader:{"bullets.fs":"./asset/shader/bullets.fs","sprites.fs":"./asset/shader/sprites.fs"}};default:throw"invalid assetType: "+t.assetType}}}})}),phina.namespace(function(){phina.define("passion.Camera",{position:null,vMatrix:null,pMatrix:null,vpMatrix:null,init:function(){this.position=vec3.create(),this.vMatrix=mat4.create(),this.pMatrix=mat4.create(),this.vpMatrix=mat4.create()},setPosition:function(t,e,i){return vec3.set(this.position,t,e,i),this},lookAt:function(t,e,i){return mat4.lookAt(this.vMatrix,this.position,[t,e,i],[0,1,0]),this},ortho:function(t,e,i,a,s,n){return mat4.ortho(this.pMatrix,t,e,i,a,s,n),this},perspective:function(t,e,i,a){return mat4.perspective(this.pMatrix,t,e,i,a),this},calcVpMatrix:function(){return mat4.mul(this.vpMatrix,this.pMatrix,this.vMatrix),this},uniformValues:function(){return{vpMatrix:this.vpMatrix,cameraPosition:this.position}}})}),phina.namespace(function(){phina.define("passion.Background",{superClass:"passion.Sprite",init:function(t,e,i){this.superInit(t,e,i),this.on("enterframe",function(){this.y+=3,this.y>GAME_AREA_HEIGHT/2+640&&(this.y-=1280)})},spawn:function(){return passion.Sprite.prototype.spawn.call(this,{scaleX:360,scaleY:640,frameX:0,frameY:0,frameW:1,frameH:1,red:.5,green:.5,blue:.5}),this}})}),phina.namespace(function(){phina.define("passion.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,power:0,_active:!1,radius:20,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t,e){var i=this.instanceData,a=this.index;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,i[a+0]=this.x,i[a+1]=this.y,i[a+2]=t.direction,i[a+3]=e.scale,i[a+4]=e.type%8,i[a+5]=~~(e.type/8),i[a+6]=1,i[a+7]=1,i[a+8]=.2+~~(e.type/8)%2,i[a+9]=.2,i[a+10]=.2+~~(e.type/8)%2+1;var s=this;return t.onVanish=function(){s.remove()},this},activate:function(){return this._active=!0,this.flare("activated"),this},inactivate:function(){return this._active=!1,this.flare("inactivated"),this},onremoved:function(){this.instanceData[this.index+6]=0},update:function(t){var e=this.instanceData,i=this.index,a=this.runner;return a.update(),this.x=a.x,this.y=a.y,this.x<-50||GAME_AREA_WIDTH+50<this.x||this.y<-50||GAME_AREA_HEIGHT+50<this.y?void this.remove():(e[i+0]=this.x,e[i+1]=this.y,e[i+7]=1.5+.6*Math.sin(.2*this.age),void(this.age+=1))},hitPlayer:function(t){this.remove()}})}),phina.namespace(function(){phina.define("passion.BulletDrawer",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:500,init:function(t,e,i,a){this.superInit(t,e);var s=phigl.Program(t).attach("bullets.vs").attach("bullets.fs").link();this.setProgram(s).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-.5,.5,.5,.5,-.5,-.5,.5,-.5]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vpMatrix","texture","globalScale");var n=this.instanceStride/4,r=phigl.Texture(t,"bullets.png");this.uniforms.texture.setValue(0).setTexture(r),this.uniforms.globalScale.setValue(1);for(var h=this.instanceData=[],o=0;o<this._count;o++)h.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(h);var l=this;this.pool=Array.range(0,this._count).map(function(t){return passion.Bullet(t,h,n).on("removed",function(){l.pool.add(this)})}).toPool(function(t,e){return t.id-e.id})},get:function(){return this.pool.get()},update:function(t){this.setInstanceAttributeData(this.instanceData)},render:function(t){var e=this.gl;e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.uniforms.globalScale.value=1,t&&t.forIn(function(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}.bind(this)),this.draw(this._count)}})}),phina.namespace(function(){phina.define("passion.GLLayer",{superClass:"phina.display.Layer",static:{GL_CANVAS:null,GL:null},renderChildBySelf:!0,ready:!1,domElement:null,gl:null,camera:null,bgDrawer:null,enemyDrawer:null,effectDrawer:null,playerDrawer:null,bulletDrawer:null,topEffectDrawer:null,init:function(){this.superInit({width:GAME_AREA_WIDTH,height:GAME_AREA_HEIGHT}),this.originX=0,this.originY=0,null==passion.GLLayer.GL_CANVAS&&(passion.GLLayer.GL_CANVAS=document.createElement("canvas"),passion.GLLayer.GL=passion.GLLayer.GL_CANVAS.getContext("webgl")),this.domElement=passion.GLLayer.GL_CANVAS,this.domElement.width=this.width*passion.GLLayer.quality,this.domElement.height=this.height*passion.GLLayer.quality;var t=this.gl=passion.GLLayer.GL,e=phigl.Extensions.getInstancedArrays(t);t.viewport(0,0,this.domElement.width,this.domElement.height),t.clearColor(0,0,0,1),t.clearDepth(1),t.disable(t.CULL_FACE),t.enable(t.BLEND),t.disable(t.DEPTH_TEST);var i=this.domElement.width,a=this.domElement.height,s=this.width,n=this.height;Math.pow(2,~~Math.log2(i)+1),Math.pow(2,~~Math.log2(a)+1);this.camera=passion.Camera().setPosition(.5*s,.5*n,2e3).lookAt(.5*s,.5*n,0).ortho(.5*-s,.5*s,.5*n,.5*-n,.1,3e3).calcVpMatrix(),this.bgDrawer=passion.SpritDrawer(t,e,s,n),this.enemyDrawer=passion.SpritDrawer(t,e,s,n),this.effectDrawer=passion.SpritDrawer(t,e,s,n),this.playerDrawer=passion.SpritDrawer(t,e,s,n),this.bulletDrawer=passion.BulletDrawer(t,e,s,n),this.topEffectDrawer=passion.SpritDrawer(t,e,s,n),this.ready=!0},update:function(t){this.ready&&(this.bgDrawer.update(t),this.enemyDrawer.update(t),this.effectDrawer.update(t),this.playerDrawer.update(t),this.bulletDrawer.update(t),this.topEffectDrawer.update(t))},draw:function(t){if(this.ready){var e=this.gl,i=this.domElement,a=i.width,s=i.height,n=this.camera.uniformValues();e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.bgDrawer.render(n),this.enemyDrawer.render(n),this.effectDrawer.render(n),this.playerDrawer.render(n),this.bulletDrawer.render(n),this.topEffectDrawer.render(n),e.flush(),t.context.drawImage(i,0,0,a,s,0,0,this.width,this.height)}},_static:{quality:1}})}),phina.namespace(function(){phina.define("passion.Player",{superClass:"passion.Sprite",_roll:0,init:function(t,e,i){this.superInit(t,e,i),this.on("enterframe",function(t){this.controll(t.app)})},spawn:function(){return passion.Sprite.prototype.spawn.call(this,{scaleX:60,scaleY:60,frameX:3/8,frameY:0,frameW:1/8,frameH:1/8}),this},controll:function(t){var e=t.pointer,i=e.deltaPosition;e.getPointing()&&(this.x+=2*i.x,this.y+=2*i.y,this.x=Math.clamp(this.x,5,GAME_AREA_WIDTH-5),this.y=Math.clamp(this.y,5,GAME_AREA_HEIGHT-5))},acceccor:{roll:{get:function(){return this._roll},set:function(t){this._roll=Math.clamp(t,-3,3);var e=~~this._roll;-3<e&&e<0&&(e+=1),this.frameX=(e+3)/8}}}})}),phina.namespace(function(){phina.define("passion.SpritDrawer",{superClass:"phigl.InstancedDrawable",objTypes:null,objParameters:null,init:function(t,e,i,a){this.superInit(t,e),this.objTypes=[],this.objParameters={};var s=phigl.Program(t).attach("sprites.vs").attach("sprites.fs").link();this.setProgram(s).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-.5,.5,.5,.5,-.5,-.5,.5,-.5]},{unitSize:2,data:[0,1,1,1,0,0,1,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceColor").setUniforms("vpMatrix","texture","globalScale");this.instanceStride/4;this.uniforms.globalScale.setValue(1)},addObjType:function(t,e){if(e={}.$extend({className:"passion.Sprite",count:1,texture:null,additiveBlending:!1},e),!this.objTypes.contains(t)){var i=this.instanceStride/4;this.objTypes.push(t);var a=this.objParameters[t]={count:e.count,instanceVbo:phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW),texture:phigl.Texture(this.gl,e.texture),pool:null,additiveBlending:e.additiveBlending,instanceData:Array.range(e.count).map(function(t){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0]}).flatten()},s=phina.using(e.className);a.pool=Array.range(e.count).map(function(t){return s(t,a.instanceData,i).on("removed",function(){a.pool.push(this)})})}},get:function(t){return this.objParameters[t].pool.shift()},update:function(){},render:function(t){if(0!==this.objTypes.length){var e=this.gl;this.uniforms.globalScale.value=1,t&&t.forIn(function(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}.bind(this));var i=this;this.objTypes.forEach(function(t){var a=i.objParameters[t];a.additiveBlending?e.blendFunc(e.SRC_ALPHA,e.ONE):e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),i.setInstanceAttributeVbo(a.instanceVbo.set(a.instanceData)),i.uniforms.texture.setValue(0).setTexture(a.texture),i.draw(a.count)})}}})}),phina.namespace(function(){phina.define("passion.Sprite",{superClass:"phina.app.Element",id:-1,instanceData:null,visible:!0,x:0,y:0,rotation:0,scale:0,frameX:0,frameY:0,frameW:0,frameH:0,red:1,green:1,blue:1,alpha:1,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t){t.$safe({visible:!0,x:0,y:0,rotation:0,scaleX:1,scaleY:1,frameX:0,frameY:0,frameW:1/8,frameH:1/8,red:1,green:1,blue:1,alpha:1});var e=this.index,i=this.instanceData;return this.visible=t.visible,this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.frameX=t.frameX,this.frameY=t.frameY,this.frameW=t.frameW,this.frameH=t.frameH,this.red=t.red,this.green=t.green,this.blue=t.blue,this.alpha=t.alpha,i[e+0]=this.visible?1:0,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scaleX,i[e+5]=this.scaleY,i[e+6]=this.frameX,i[e+7]=this.frameY,i[e+8]=this.frameW,i[e+9]=this.frameH,i[e+10]=this.red,i[e+11]=this.green,i[e+12]=this.blue,i[e+13]=this.alpha,this.age=0,this},update:function(t){var e=this.index,i=this.instanceData;i[e+0]=this.visible?1:0,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scaleX,i[e+5]=this.scaleY,i[e+6]=this.frameX,i[e+7]=this.frameY,i[e+8]=this.frameW,i[e+9]=this.frameH,i[e+10]=this.red,i[e+11]=this.green,i[e+12]=this.blue,i[e+13]=this.alpha,this.age+=1},onremoved:function(){this.visible=!1,this.instanceData[this.index+0]=0}})}),phina.namespace(function(){phina.define("passion.Pool",{array:null,dirty:null,comparator:null,init:function(t,e){this.array=t||[],this.comparator=e||function(t,e){return t-e},this.dirty=!0},add:function(t){this.array.push(t),this.dirty=!0},get:function(){return this.dirty&&(this.array.sort(this.comparator),this.dirty=!1),this.array.shift()}}),Array.prototype.$method("toPool",function(t){return passion.Pool(this,t)})}),phina.namespace(function(){phina.define("passion.GameScene",{superClass:"phina.display.DisplayScene",init:function(){this.superInit(),this.fromJSON({children:{bg:{className:"phina.display.Sprite",arguments:this.drawBgTexture(),originX:0,originY:0},glLayer:{className:"passion.GLLayer"},uiLayer:{className:"phina.display.DisplayElement",originX:0,originY:0}}}),this.glLayer.bgDrawer.addObjType("bg",{className:"passion.Background",texture:"test.png",count:2});var t=this.glLayer.bgDrawer.get("bg");t.spawn(),t.x=GAME_AREA_WIDTH/2,t.y=GAME_AREA_HEIGHT/2,t.addChildTo(this.glLayer);var e=this.glLayer.bgDrawer.get("bg");e.spawn(),e.x=GAME_AREA_WIDTH/2,e.y=GAME_AREA_HEIGHT/2-640,e.addChildTo(this.glLayer),this.glLayer.effectDrawer.addObjType("effect",{texture:"texture0.png",additiveBlending:!0,count:500}),this.on("enterframe",function(t){if(t.app.ticker.frame%2===0){var e=this.glLayer.effectDrawer.get("effect");if(e){var a=Math.randfloat(-1,1);e.onenterframe=function(){this.x+=a,this.y+=2,this.alpha*=.9,this.alpha<.01&&this.remove()};var s=Math.randfloat(22,32);e.spawn({scaleX:s,scaleY:s,frameX:7/8,frameY:0,frameW:1/8,frameH:1/8,red:.2,green:1,blue:.8,alpha:1}),e.addChildTo(this.glLayer),e.x=i.x,e.y=i.y+15}}}),this.glLayer.playerDrawer.addObjType("player",{className:"passion.Player",texture:"texture0.png"});var i=this.glLayer.playerDrawer.get("player");i.spawn(),i.addChildTo(this.glLayer),i.x=100,i.y=100,this.glLayer.topEffectDrawer.addObjType("effect",{texture:"texture0.png",count:2});var a=this.glLayer.topEffectDrawer.get("effect");a.spawn({scaleX:14,scaleY:14,frameX:7/8,frameY:0,frameW:1/8,frameH:1/8,red:.4,green:2,blue:1.6,alpha:1}),a.addChildTo(this.glLayer),a.on("enterframe",function(){this.x=i.x,this.y=i.y,this.rotation+=.1});var s=this.glLayer.topEffectDrawer.get("effect");s.spawn({scaleX:8,scaleY:8,frameX:7/8,frameY:0,frameW:1/8,frameH:1/8,red:.4,green:2,blue:1.6,alpha:1,rotation:.5}),s.addChildTo(this.glLayer),s.on("enterframe",function(){this.x=i.x,this.y=i.y,this.rotation+=.1});var n=this.glLayer.effectDrawer.get("effect");n.spawn({scaleX:80,scaleY:80,frameX:0,frameY:1/8,frameW:1/8,frameH:1/8,red:2,green:2,blue:2,alpha:.3}),n.addChildTo(this.glLayer),n.on("enterframe",function(){this.x=i.x,this.y=i.y}),bulletml.dsl();var r=new bulletml.Root({top0:action([repeat(1/0,[repeat(50,[fire(bullet({type:9}),direction(7,"sequence"),speed(3)),fire(bullet({type:1}),direction(90,"sequence"),speed(2)),fire(bullet({type:9}),direction(90,"sequence"),speed(3)),fire(bullet({type:1}),direction(90,"sequence"),speed(2)),fire(bullet({type:9}),direction(90,"sequence"),speed(3)),wait(1)]),wait(120)])])}),h=this.glLayer,o=this.glLayer.bulletDrawer,l=r.createRunner({target:i,createNewBullet:function(t,e){var i=o.get();i&&(i.spawn(t,{type:e.type,scale:32}),i.addChildTo(h))}});i.on("enterframe",function(){l.x=this.x,l.y=this.y,l.update()})},drawBgTexture:function(){var t=phina.graphics.Canvas();return t.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),t.clearColor("hsla(190, 100%, 95%, 0.1)"),150..times(function(e,i){var a=1.5*SCREEN_HEIGHT/i*e;t.strokeStyle="hsla(190, 100%, 95%, 0.2)",t.strokeLines(0*SCREEN_WIDTH,a-10,.1*SCREEN_WIDTH,a-10,.2*SCREEN_WIDTH,a+20,.5*SCREEN_WIDTH,a+20,.6*SCREEN_WIDTH,a-30,.7*SCREEN_WIDTH,a-30,.8*SCREEN_WIDTH,a-50,1*SCREEN_WIDTH,a-50),t.strokeStyle="hsla(190, 100%, 65%, 0.2)",a+=1,t.strokeLines(0*SCREEN_WIDTH,a-10,.1*SCREEN_WIDTH,a-10,.2*SCREEN_WIDTH,a+20,.5*SCREEN_WIDTH,a+20,.6*SCREEN_WIDTH,a-30,.7*SCREEN_WIDTH,a-30,.8*SCREEN_WIDTH,a-50,1*SCREEN_WIDTH,a-50),t.strokeStyle="hsla(190, 100%, 35%, 0.2)",a+=1,t.strokeLines(0*SCREEN_WIDTH,a-10,.1*SCREEN_WIDTH,a-10,.2*SCREEN_WIDTH,a+20,.5*SCREEN_WIDTH,a+20,.6*SCREEN_WIDTH,a-30,.7*SCREEN_WIDTH,a-30,.8*SCREEN_WIDTH,a-50,1*SCREEN_WIDTH,a-50)}),t}})});